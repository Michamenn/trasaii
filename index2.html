<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Administrativo do Restaurante Aprimorado</title>
    <!-- Chosen Palette: Serene Management (A more refined variant of the previous palette, using dark slate blues for primary elements, light grays for backgrounds, and subtle teals for interactive elements and accents.) -->
    <!-- Application Structure Plan: A dashboard-style SPA with a persistent sidebar navigation and a main content area. The sidebar allows quick access to different management modules (Dashboard, Cardápio, Pedidos (now including KDS tab), Cupons, Loja, Financeiro (now including Fluxo de Caixa and Caixa Diário), Avaliações, Vendas, FAQ, Embalagens, Orçamentos, Redes Sociais, Frete, Gerenciamento IA WhatsApp, Tracking de Pedidos, Comunicação). The main content area dynamically updates to display the selected module's interface. This structure provides a clear, organized workspace for restaurant owners, mirroring common admin panel designs for ease of use and efficient task management, with added sections for detailed insights and tips from the partner manual and new dedicated modules for specific operational needs. -->
    <!-- Visualization & Content Choices: 
        - Dashboard Overview -> Goal: Inform/Summarize. Presentation: Enhanced key metrics cards with more context (e.g., average ticket), simple bar chart (Chart.js) for daily sales. Interaction: Static for MVP. Justification: Provides a quick glance at critical business performance.
        - Menu Management -> Goal: Organize/Manage. Presentation: Interactive list/table with CRUD forms. Interaction: Buttons for Add/Edit/Delete, toggles for active/promotion/out of stock. Edit functionality implemented via modal for better UX. AI description generation for dish descriptions. Justification: Direct manipulation of menu items, central to restaurant operations, now with improved edit flow, support for item types (e.g., multi-flavor pizzas), and AI assistance.
        - Order Management -> Goal: Inform/Action. Presentation: Order list with expandable details, color-coded status badges, confirmation timer for new orders. KDS tab provides a simplified view for kitchen. Interaction: Click to view/hide details, click buttons to change order status, simulate chat with client (now with AI-suggested responses), print command, switch KDS view. Justification: Enables efficient processing of incoming orders with better visual cues, critical time awareness, integrated communication/printing tools, and AI support for client interaction. KDS optimizes kitchen workflow.
        - Coupon Management -> Goal: Manage. Presentation: Form for creation, list of existing coupons. Interaction: Form submission, toggle active status. Justification: Allows restaurants to create and manage promotions.
        - Store Settings -> Goal: Configure. Presentation: Forms/toggles for various settings including detailed operating hours, payment methods, flexible store availability (with immediate pause), scheduled delivery toggle, and new module activation toggles. Interaction: Input fields, checkboxes, date pickers, radios. Justification: Empowers restaurant owners to control their operational parameters with more granularity and manage optional features, centralizing module activation.
        - Financial Overview -> Goal: Inform/Manage. Presentation: Expanded tabular data for financial summary, sample invoices, and payment status. New sub-section for Fluxo de Caixa (cash flow) with entry/exit forms, real-time balance, and conceptual reports. New section for Caixa Diário to manage daily cash register operations. Justification: Provides transparency and insights into financial performance, commission/payment details, basic cash flow management, and crucial daily cash reconciliation.
        - Customer Reviews -> Goal: Inform/Analyze. Presentation: List of reviews with rating summary. Interaction: Filters by star rating (conceptual). Justification: Provides actionable feedback to improve service.
        - Sales Growth Tips -> Goal: Educate/Empower. Presentation: Accordion-style sections for various growth strategies. New AI promotion idea generator. Interaction: Click to expand/collapse, AI button for ideas. Justification: Directly incorporates valuable advice from the partner manual in an easily digestible format, enhanced by AI creativity.
        - FAQ -> Goal: Support/Inform. Presentation: Comprehensive accordion for frequently asked questions, pulling directly from the partner manual. Interaction: Click to expand/collapse. Justification: Centralizes support information, reducing need for direct contact for common issues.
        - Packaging Management -> Goal: Manage. Presentation: List/table of packaging types with cost and active status. Interaction: Add/Edit/Delete packaging. Justification: Allows for management of additional costs or item specifics.
        - Budget Requests -> Goal: Manage/Inform. Presentation: List of hypothetical budget/quote requests with status. Interaction: View details, change status. Justification: Provides a dedicated space for special order inquiries.
        - Social Media Module -> Goal: Inform/Manage. Presentation: Input fields for social media links. Justification: Centralizes the management of restaurant's social media presence for promotion.
        - IA WhatsApp Management Module -> Goal: Configure. Presentation: Basic configuration options for the WhatsApp AI agent. Justification: Provides control over the automated interactions.
        - Shipping Module -> Goal: Configure. Presentation: Radio buttons and input fields for various shipping rate models. Justification: Offers flexible control over delivery costs.
        - Tracking de Pedidos (Entregadores Próprios) -> Goal: Monitor. Presentation: Simulated map view with driver icons and order routes. Interaction: Conceptual drag/drop driver. Justification: Visualizes delivery logistics for restaurants with own fleet.
        - Comunicação (Chat Templates) -> Goal: Facilitate. Presentation: Form to manage predefined chat messages for customer interaction. Justification: Enables quick and consistent customer communication from order details.
        - Real-time Notifications (Pop-ups) -> Goal: Alert. Presentation: Floating toast messages for new orders/cancellations. Interaction: Auto-dismiss or manual dismiss. Justification: Provides immediate, non-intrusive alerts for critical events, with intelligence to prevent repeat alerts for the same event.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; } /* slate-50 */
        .sidebar-link.active { background-color: #3b82f6; color: white; } /* indigo-500 */
        .chart-container { position: relative; height: 300px; max-height: 400px; width: 100%; max-width: 600px; margin-left: auto; margin-right: auto; }
        .tab-button.active { @apply border-indigo-500 text-indigo-600; }
        .order-status-badge { @apply text-xs px-2 py-1 rounded-full font-semibold; }
        .status-Confirmado { @apply bg-indigo-100 text-indigo-700; }
        .status-Em-Preparo { @apply bg-yellow-100 text-yellow-700; }
        .status-Saiu-para-Entrega { @apply bg-blue-100 text-blue-700; }
        .status-Entregue { @apply bg-green-100 text-green-700; }
        .status-Cancelado { @apply bg-red-100 text-red-700; }
        .accordion-header { @apply w-full p-4 text-left font-semibold text-slate-800 flex justify-between items-center hover:bg-slate-100 transition-colors; }
        .accordion-content { @apply p-4 pt-0 text-slate-600 transition-all duration-300 ease-in-out; max-height: 0; overflow: hidden; }
        .accordion-button-icon { @apply transform transition-transform duration-300; }
        .accordion-header.active .accordion-button-icon { @apply rotate-180; }
        .toast-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #3b82f6; /* indigo-500 */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
            transform: translateY(20px);
            z-index: 1000;
        }
        .toast-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        .map-placeholder {
            background-color: #e2e8f0; /* slate-200 */
            border: 1px dashed #94a3b8; /* slate-400 */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #64748b; /* slate-500 */
        }
        .kds-order-card {
            border: 1px solid #e2e8f0;
            background-color: #ffffff;
            border-radius: 0.5rem;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .kds-order-card.ready {
            background-color: #dcfce7; /* green-50 */
            border-color: #10b981; /* green-500 */
        }
        .kds-order-card.preparing {
            background-color: #fefce8; /* yellow-50 */
            border-color: #eab308; /* yellow-500 */
        }
        /* New style for AI suggestions */
        .ai-suggestion {
            background-color: #e0f2fe; /* Light blue */
            border: 1px solid #90cdf4; /* Medium blue */
            color: #2b6cb0; /* Darker blue */
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .ai-suggestion:hover {
            background-color: #bfdbfe; /* Lighter blue on hover */
        }
        /* Custom Modal Styles */
        #custom-alert-modal {
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden">

    <!-- Sidebar de Navegação -->
    <aside class="w-64 bg-slate-900 text-slate-100 flex flex-col p-4 shadow-xl">
        <div class="text-2xl font-bold mb-8 text-white">Painel do Parceiro</div>
        <nav class="flex-grow">
            <ul class="space-y-2">
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition active" data-section="dashboard">📊 Dashboard</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="menu">🍔 Gestão de Cardápio</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="orders">📦 Gestão de Pedidos</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="coupons">🏷️ Gestão de Cupons</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="settings">⚙️ Configurações da Loja</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="financial">💰 Financeiro</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="reviews">⭐ Avaliações</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="sales-growth">📈 Aumentar Vendas</button></li>
                <li id="sidebar-packaging-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="packaging">📦 Embalagens</button></li>
                <li id="sidebar-budget-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="budget">💲 Orçamentos</button></li>
                <li id="sidebar-social-media-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="social-media">🌐 Redes Sociais</button></li>
                <li id="sidebar-shipping-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="shipping">🚚 Frete</button></li>
                <li id="sidebar-ia-whatsapp-mgmt-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="ia-whatsapp-management">💬 Gestão IA WhatsApp</button></li>
                <li id="sidebar-tracking-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="tracking">📍 Tracking de Pedidos</button></li>
                <li id="sidebar-communication-link-container" class="hidden"><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="communication">🗣️ Comunicação</button></li>
                <li><button class="sidebar-link w-full text-left p-3 rounded-lg hover:bg-slate-700 transition" data-section="faq">❓ Perguntas Frequentes</button></li>
            </ul>
        </nav>
        <div class="mt-8 text-center text-xs text-slate-400">
            © 2025 AI Delivery
        </div>
    </aside>

    <!-- Área de Conteúdo Principal -->
    <main class="flex-grow p-8 overflow-y-auto">
        <h1 id="main-title" class="text-3xl font-bold text-slate-900 mb-6">Dashboard</h1>

        <!-- Seção Dashboard -->
        <section id="dashboard" class="content-section">
            <p class="text-slate-600 mb-6">Visão geral do desempenho do seu restaurante, com métricas chave e um gráfico de vendas diárias.</p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <p class="text-slate-500 text-sm">Vendas Hoje</p>
                    <p class="text-2xl font-bold text-teal-600">R$ <span id="dashboard-sales-today">0.00</span></p>
                    <p class="text-slate-500 text-xs mt-1">Ticket médio: R$ <span id="dashboard-avg-ticket">0.00</span></p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <p class="text-slate-500 text-sm">Pedidos Ativos</p>
                    <p class="text-2xl font-bold text-indigo-600"><span id="dashboard-active-orders">0</span></p>
                    <p class="text-slate-500 text-xs mt-1"><span id="dashboard-new-orders-count">0</span> novos aguardando confirmação</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <p class="text-slate-500 text-sm">Avaliação Média</p>
                    <p class="text-2xl font-bold text-amber-600"><span id="dashboard-avg-rating">0.0</span> ⭐</p>
                    <p class="text-slate-500 text-xs mt-1">Baseado em <span id="dashboard-total-reviews">0</span> avaliações</p>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Vendas Diárias (Últimos 7 dias)</h3>
                <div class="chart-container">
                    <canvas id="salesChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mt-8">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Dicas Rápidas do Parceiro</h3>
                <ul class="list-disc list-inside text-slate-600 space-y-2">
                    <li>Gerencie seu tempo de entrega diariamente: aumente em dias de pico e diminua em dias de menor movimento.</li>
                    <li>Confirme seus pedidos em até 4 minutos para evitar cancelamentos automáticos.</li>
                    <li>75% dos clientes não confirmados pedem em outro restaurante. Não perca vendas!</li>
                    <li>Sempre envie a nota fiscal com o pedido. Clientes podem avaliar mal a falta dela!</li>
                </ul>
            </div>
        </section>

        <!-- Seção Gestão de Cardápio -->
        <section id="menu" class="content-section hidden">
            <p class="text-slate-600 mb-6">Gerencie seus itens do cardápio: adicione, edite, remova e defina status de disponibilidade ou promoção.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Adicionar Novo Item</h3>
                <form id="add-item-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="item-name" class="block text-slate-700 text-sm font-bold mb-2">Nome do Item:</label>
                        <input type="text" id="item-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Pizza Margherita" required>
                    </div>
                    <div>
                        <label for="item-category" class="block text-slate-700 text-sm font-bold mb-2">Categoria:</label>
                        <select id="item-category" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="Pizzas">Pizzas</option>
                            <option value="Hambúrgueres">Hambúrgueres</option>
                            <option value="Sushi">Sushi</option>
                            <option value="Sobremesas">Sobremesas</option>
                            <option value="Bebidas">Bebidas</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div>
                        <label for="item-price" class="block text-slate-700 text-sm font-bold mb-2">Preço:</label>
                        <input type="number" id="item-price" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="45.00" required>
                    </div>
                    <div id="pizza-flavors-input-group" class="hidden">
                        <label for="item-flavors" class="block text-slate-700 text-sm font-bold mb-2">Sabores (separados por vírgula):</label>
                        <input type="text" id="item-flavors" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Calabresa, Quatro Queijos, Frango">
                    </div>
                    <div>
                        <label for="item-promo-price" class="block text-slate-700 text-sm font-bold mb-2">Preço Promocional (Opcional):</label>
                        <input type="number" id="item-promo-price" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="39.90">
                    </div>
                    <div class="md:col-span-2">
                        <label for="item-description" class="block text-slate-700 text-sm font-bold mb-2">Descrição:</label>
                        <textarea id="item-description" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline h-20" placeholder="Deliciosa pizza com molho de tomate, mussarela e manjericão."></textarea>
                        <button type="button" id="generate-description-btn" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-lg mt-2 transition">Gerar com IA ✨</button>
                    </div>
                    <div>
                        <label for="item-image" class="block text-slate-700 text-sm font-bold mb-2">URL da Imagem (Placeholder):</label>
                        <input type="text" id="item-image" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="https://placehold.co/100x100">
                    </div>
                    <div class="flex items-center space-x-4 md:col-span-2">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="item-active" class="form-checkbox text-teal-600" checked>
                            <span class="ml-2 text-slate-700">Disponível para venda</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="item-promo-toggle" class="form-checkbox text-indigo-600">
                            <span class="ml-2 text-slate-700">Aplicar Promoção</span>
                        </label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Adicionar Item</button>
                    </div>
                </form>
            </div>

            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Itens do Cardápio</h3>
                <div id="menu-items-list" class="space-y-4">
                    <!-- Itens do cardápio serão carregados aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Gestão de Pedidos -->
        <section id="orders" class="content-section hidden">
            <p class="text-slate-600 mb-6">Acompanhe e gerencie todos os pedidos recebidos. Confirme, atualize o status e veja os detalhes.</p>
            <div class="flex justify-start space-x-4 mb-6">
                <button id="orders-tab-list" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 transition active">Lista de Pedidos</button>
                <button id="orders-tab-kds" class="tab-button px-4 py-2 text-sm font-medium border-b-2 border-transparent text-slate-500 hover:text-slate-700 hover:border-slate-300 transition">KDS (Cozinha)</button>
            </div>
            <div id="orders-list-view">
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">Pedidos Ativos <span id="new-orders-count" class="bg-red-500 text-white text-sm px-2 py-0.5 rounded-full ml-2"></span></h3>
                    <div id="active-orders-list" class="space-y-4">
                        <!-- Pedidos ativos serão carregados aqui -->
                    </div>
                    <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">Histórico de Pedidos</h3>
                    <div id="order-history-list" class="space-y-4">
                        <!-- Histórico de pedidos será carregado aqui -->
                    </div>
                </div>
            </div>
            <div id="orders-kds-view" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">KDS - Monitor da Cozinha</h3>
                    <p class="text-slate-600 mb-6">Visualize e gerencie os pedidos em preparação. Clique em um pedido para marcá-lo como "Pronto".</p>
                    <div id="kds-orders-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Pedidos no KDS serão carregados aqui -->
                    </div>
                </div>
            </div>
        </section>

        <!-- Seção Gestão de Cupons -->
        <section id="coupons" class="content-section hidden">
            <p class="text-slate-600 mb-6">Crie e gerencie códigos promocionais para atrair mais clientes e impulsionar suas vendas.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Criar Novo Cupom</h3>
                <form id="add-coupon-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="coupon-code" class="block text-slate-700 text-sm font-bold mb-2">Código do Cupom:</label>
                        <input type="text" id="coupon-code" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="FRETEGRATIS" required>
                    </div>
                    <div>
                        <label for="coupon-type" class="block text-slate-700 text-sm font-bold mb-2">Tipo de Desconto:</label>
                        <select id="coupon-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="percentage">Porcentagem (%)</option>
                            <option value="fixed">Valor Fixo (R$)</option>
                            <option value="shipping">Frete Grátis</option>
                        </select>
                    </div>
                    <div>
                        <label for="coupon-value" class="block text-slate-700 text-sm font-bold mb-2">Valor (ex: 10 para 10% ou 15.00 para R$15):</label>
                        <input type="number" id="coupon-value" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="10.00" required>
                    </div>
                    <div>
                        <label for="coupon-min-order" class="block text-slate-700 text-sm font-bold mb-2">Valor Mínimo do Pedido:</label>
                        <input type="number" id="coupon-min-order" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="0.00">
                    </div>
                    <div>
                        <label for="coupon-expiry" class="block text-slate-700 text-sm font-bold mb-2">Data de Validade:</label>
                        <input type="date" id="coupon-expiry" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                    <div>
                        <label for="coupon-usage-limit" class="block text-slate-700 text-sm font-bold mb-2">Limite de Usos (0 para ilimitado):</label>
                        <input type="number" id="coupon-usage-limit" step="1" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="0">
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="coupon-active" class="form-checkbox text-teal-600" checked>
                            <span class="ml-2 text-slate-700">Ativo</span>
                        </label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Criar Cupom</button>
                    </div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Cupons Ativos</h3>
                <div id="coupon-list" class="space-y-4">
                    <!-- Cupons serão carregados aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Configurações da Loja -->
        <section id="settings" class="content-section hidden">
            <p class="text-slate-600 mb-6">Ajuste as configurações operacionais do seu restaurante, incluindo horários, formas de pagamento e status.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Informações Gerais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="delivery-time" class="block text-slate-700 text-sm font-bold mb-2">Tempo de Entrega Médio (minutos):</label>
                        <input type="number" id="delivery-time" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="40">
                    </div>
                    <div>
                        <label for="min-order-value-setting" class="block text-slate-700 text-sm font-bold mb-2">Valor Mínimo do Pedido:</label>
                        <input type="number" id="min-order-value-setting" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="25.00">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-slate-700 text-sm font-bold mb-2">Disponibilidade da Loja:</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="store-status" value="open" class="form-radio text-teal-600" checked>
                                <span class="ml-2 text-slate-700">Aberto</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="store-status" value="closed" class="form-radio text-red-600">
                                <span class="ml-2 text-slate-700">Fechado Temporariamente</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="store-status" value="schedule-close" class="form-radio text-amber-600">
                                <span class="ml-2 text-slate-700">Programar Fechamento</span>
                            </label>
                            <button id="pause-now-button" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-1 px-3 rounded-lg focus:outline-none focus:shadow-outline transition">Pausar Agora</button>
                        </div>
                    </div>
                    <div id="schedule-close-options" class="md:col-span-2 hidden bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <label for="schedule-start-date" class="block text-slate-700 text-sm font-bold mb-2">Início do Fechamento:</label>
                        <input type="date" id="schedule-start-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline mb-4">
                        <label for="schedule-end-date" class="block text-slate-700 text-sm font-bold mb-2">Fim do Fechamento:</label>
                        <input type="date" id="schedule-end-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
                    </div>
                </div>

                <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">Horário de Funcionamento</h3>
                <div id="operating-hours-config" class="space-y-4">
                    <!-- Horários de funcionamento serão gerados aqui -->
                </div>
                <button id="add-hour-slot" class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg mt-4 focus:outline-none focus:shadow-outline transition">+ Adicionar Turno</button>

                <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">Formas de Pagamento</h3>
                <div id="payment-methods-config" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <!-- Formas de pagamento serão geradas aqui -->
                </div>
                <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">Área de Entrega</h3>
                <div class="flex items-center space-x-4">
                    <p class="text-slate-700">Sua área de entrega atual é de 5km de raio.</p>
                    <button class="bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition" onclick="showAlert('Funcionalidade para alterar a área de entrega será implementada.')">Alterar Área</button>
                </div>

                <h3 class="text-xl font-bold text-slate-800 mt-8 mb-4">Módulos Opcionais</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-notifications" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Notificações Pop-up</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-packaging" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Módulo de Embalagens</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-budget" class="form-checkbox text-indigo-600">
                            <span class="ml-2 text-slate-700">Ativar Módulo de Orçamentos</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-scheduled-delivery" class="form-checkbox text-indigo-600">
                            <span class="ml-2 text-slate-700">Permitir Agendamento de Entrega</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-social-media" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Módulo de Redes Sociais</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-ia-whatsapp-mgmt" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Gerenciamento IA WhatsApp</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-shipping-rates" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Módulo de Frete</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-print-command" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Impressão de Comanda</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-tracking" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Tracking de Pedidos (Entreg. Próprios)</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-communication" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Módulo de Comunicação (Templates Chat)</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="module-cashflow" class="form-checkbox text-indigo-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Módulo de Fluxo de Caixa</span>
                        </label>
                    </div>
                </div>

                <div class="mt-8">
                    <button id="save-settings-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Configurações</button>
                </div>
            </div>
        </section>

        <!-- Seção Financeiro -->
        <section id="financial" class="content-section hidden">
            <p class="text-slate-600 mb-6">Visualize seus demonstrativos financeiros, comissões e faturas. Transparência total sobre seus ganhos e despesas.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Demonstrativo de Fechamento Financeiro - Julho 2025</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-slate-500 text-sm">Vendas Brutas (Pedidos Concluídos)</p>
                        <p class="text-xl font-bold text-teal-600">R$ <span id="financial-gross-sales">5.500,00</span></p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Comissão da Plataforma (10%)</p>
                        <p class="text-xl font-bold text-red-600">R$ <span id="financial-commission">550,00</span></p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Mensalidade (se aplicável)</p>
                        <p class="text-xl font-bold text-red-600">R$ <span id="financial-monthly-fee">79,00</span></p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Créditos de Cancelamentos (mês anterior)</p>
                        <p class="text-xl font-bold text-green-600">R$ <span id="financial-cancellation-credits">25,00</span></p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Impostos Retidos (IR 1,5%)</p>
                        <p class="text-xl font-bold text-red-600">R$ <span id="financial-taxes">8,25</span></p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Total Líquido a Receber/Repassado</p>
                        <p class="text-xl font-bold text-indigo-600">R$ <span id="financial-net-total">4.887,75</span></p>
                    </div>
                </div>

                <h4 class="text-lg font-semibold text-slate-800 mb-3">Últimos Boletos</h4>
                <div class="space-y-3" id="financial-invoices-list">
                    <div class="bg-slate-50 p-4 rounded-lg flex justify-between items-center border border-slate-200">
                        <div>
                            <p class="font-semibold text-slate-800">Boleto - Ago/2025</p>
                            <p class="text-slate-600 text-sm">Vencimento: 15/08/2025</p>
                            <p class="text-red-500 text-xs">Atraso: 0.33% de juros ao dia</p>
                        </div>
                        <span class="text-red-600 font-bold">R$ 629,00</span>
                    </div>
                    <div class="bg-slate-50 p-4 rounded-lg flex justify-between items-center border border-slate-200">
                        <div>
                            <p class="font-semibold text-slate-800">Boleto - Jul/2025</p>
                            <p class="text-slate-600 text-sm">Pago em: 10/07/2025</p>
                        </div>
                        <span class="text-green-600 font-bold">R$ 599,00</span>
                    </div>
                </div>
                <div class="mt-6 text-slate-600 text-sm">
                    <p class="mb-2"><strong>Envio de Informações:</strong> Boletos e demonstrativos são enviados por e-mail (e correio para boletos). Notas fiscais são enviadas pela prefeitura para o e-mail do restaurante.</p>
                    <p class="text-red-500 font-semibold">Mantenha seus contatos de cobrança sempre atualizados!</p>
                </div>
            </div>

            <!-- Módulo de Fluxo de Caixa -->
            <div id="cashflow-module-container" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mt-8 hidden">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Fluxo de Caixa</h3>
                <p class="text-slate-600 mb-6">Controle suas entradas e saídas financeiras em tempo real. Uma visão clara do seu saldo disponível.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-slate-500 text-sm">Saldo Atual</p>
                        <p id="current-balance" class="text-2xl font-bold text-green-600">R$ 7.500,00</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Próximas Contas a Pagar</p>
                        <p class="text-2xl font-bold text-red-600">R$ 1.200,00</p>
                    </div>
                </div>

                <h4 class="text-lg font-semibold text-slate-800 mb-3">Registrar Transação</h4>
                <form id="cashflow-form" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label for="transaction-type" class="block text-slate-700 text-sm font-bold mb-2">Tipo:</label>
                        <select id="transaction-type" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                            <option value="revenue">Receita</option>
                            <option value="expense">Despesa</option>
                        </select>
                    </div>
                    <div>
                        <label for="transaction-value" class="block text-slate-700 text-sm font-bold mb-2">Valor (R$):</label>
                        <input type="number" id="transaction-value" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ex: 150.00" required>
                    </div>
                    <div>
                        <label for="transaction-date" class="block text-slate-700 text-sm font-bold mb-2">Data:</label>
                        <input type="date" id="transaction-date" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                    </div>
                    <div>
                        <label for="transaction-category" class="block text-slate-700 text-sm font-bold mb-2">Categoria:</label>
                        <input type="text" id="transaction-category" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Ex: Aluguel, Vendas" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="transaction-description" class="block text-slate-700 text-sm font-bold mb-2">Descrição:</label>
                        <textarea id="transaction-description" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline h-16" placeholder="Detalhes da transação" required></textarea>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Registrar</button>
                    </div>
                </form>

                <h4 class="text-lg font-semibold text-slate-800 mb-3">Últimas Transações</h4>
                <div id="transactions-list" class="space-y-3">
                    <!-- Transações serão carregadas aqui -->
                </div>

                <div class="mt-8">
                    <h4 class="text-lg font-semibold text-slate-800 mb-3">Relatórios Financeiros</h4>
                    <p class="text-slate-600 text-sm mb-4">Visualize tendências e desempenho financeiro.</p>
                    <div class="chart-container" style="height: 250px;">
                        <canvas id="cashflowChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Módulo Caixa Diário -->
            <div id="daily-cash-module-container" class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mt-8">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Caixa Diário</h3>
                <p class="text-slate-600 mb-6">Gerencie o caixa do dia. Registre aberturas, fechamentos e movimentações.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <p class="text-slate-500 text-sm">Status do Caixa</p>
                        <p id="daily-cash-status" class="text-2xl font-bold text-red-600">Fechado</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Saldo de Abertura</p>
                        <p id="daily-cash-opening-balance" class="text-2xl font-bold text-slate-800">R$ 0,00</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Saldo Atual em Caixa</p>
                        <p id="daily-cash-current-balance" class="text-2xl font-bold text-slate-800">R$ 0,00</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Total de Entradas no Dia</p>
                        <p id="daily-cash-total-in" class="text-2xl font-bold text-green-600">R$ 0,00</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Total de Saídas no Dia</p>
                        <p id="daily-cash-total-out" class="text-2xl font-bold text-red-600">R$ 0,00</p>
                    </div>
                </div>

                <div id="daily-cash-actions" class="flex flex-wrap gap-4 mt-6">
                    <button id="open-cash-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Abrir Caixa</button>
                    <button id="close-cash-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition hidden">Fechar Caixa</button>
                    <button id="add-cash-movement-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition hidden">Adicionar Movimento</button>
                </div>

                <div id="daily-cash-movements-list" class="mt-8 space-y-3">
                    <h4 class="text-lg font-semibold text-slate-800 mb-3">Movimentações do Dia</h4>
                    <!-- Movimentações do caixa diário serão carregadas aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Avaliações -->
        <section id="reviews" class="content-section hidden">
            <p class="text-slate-600 mb-6">Entenda o feedback dos seus clientes e utilize as avaliações para melhorar seu serviço e posicionamento.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Resumo das Avaliações</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <p class="text-slate-500 text-sm">Avaliação Geral Média</p>
                        <p class="text-3xl font-bold text-amber-600"><span id="reviews-avg-rating">4.5</span> ⭐</p>
                    </div>
                    <div>
                        <p class="text-slate-500 text-sm">Total de Avaliações</p>
                        <p class="text-3xl font-bold text-slate-800"><span id="reviews-total-count">125</span></p>
                    </div>
                </div>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-slate-800 mb-3">Dicas para Boas Avaliações:</h4>
                    <ul class="list-disc list-inside text-slate-600 space-y-1">
                        <li>Cumpra o prazo de entrega definido.</li>
                        <li>Entregue o alimento em boas embalagens e com excelente qualidade.</li>
                        <li>Entre em contato com o cliente em caso de atrasos ou problemas.</li>
                        <li>Surpreenda bons clientes com brindes.</li>
                        <li>Solicite aos clientes que avaliem o pedido na plataforma.</li>
                    </ul>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Avaliações Recentes</h3>
                <div id="reviews-list" class="space-y-4">
                    <!-- Avaliações serão carregadas aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Aumentar Vendas -->
        <section id="sales-growth" class="content-section hidden">
            <p class="text-slate-600 mb-6">Ações estratégicas para impulsionar suas vendas e destacar seu restaurante na plataforma.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Gerador de Ideias de Promoções ✨</h3>
                <button id="generate-promo-ideas-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Gerar Ideias com IA</button>
                <div id="promotion-ideas-output" class="mt-4 space-y-3">
                    <!-- Ideias de promoção serão exibidas aqui -->
                </div>
            </div>
            <div id="sales-growth-accordion" class="space-y-4 bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <!-- Sales growth tips will be loaded here -->
            </div>
        </section>

        <!-- Seção Embalagens -->
        <section id="packaging" class="content-section hidden">
            <p class="text-slate-600 mb-6">Gerencie os tipos de embalagens disponíveis para seus produtos e seus respectivos custos.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Adicionar/Editar Embalagem</h3>
                <form id="packaging-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="hidden" id="packaging-id">
                    <div>
                        <label for="packaging-name" class="block text-slate-700 text-sm font-bold mb-2">Nome da Embalagem:</label>
                        <input type="text" id="packaging-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Caixa de Pizza Grande" required>
                    </div>
                    <div>
                        <label for="packaging-cost" class="block text-slate-700 text-sm font-bold mb-2">Custo (R$):</label>
                        <input type="number" id="packaging-cost" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="2.50" required>
                    </div>
                    <div class="md:col-span-2 flex items-center">
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="packaging-active" class="form-checkbox text-teal-600" checked>
                            <span class="ml-2 text-slate-700">Ativa</span>
                        </label>
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Embalagem</button>
                    </div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Embalagens Ativas</h3>
                <div id="packaging-list" class="space-y-4">
                    <!-- Embalagens serão carregadas aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Orçamentos -->
        <section id="budget" class="content-section hidden">
            <p class="text-slate-600 mb-6">Gerencie solicitações de orçamento para grandes pedidos ou eventos. Responda e acompanhe o status.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Solicitações de Orçamento</h3>
                <div id="budget-requests-list" class="space-y-4">
                    <!-- Orçamentos serão carregados aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Redes Sociais -->
        <section id="social-media" class="content-section hidden">
            <p class="text-slate-600 mb-6">Gerencie os links das suas redes sociais para aparecer na página do seu restaurante na plataforma.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Links das Redes Sociais</h3>
                <form id="social-media-form" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="social-facebook" class="block text-slate-700 text-sm font-bold mb-2">Facebook URL:</label>
                        <input type="url" id="social-facebook" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="https://facebook.com/seurestaurante">
                    </div>
                    <div>
                        <label for="social-instagram" class="block text-slate-700 text-sm font-bold mb-2">Instagram URL:</label>
                        <input type="url" id="social-instagram" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="https://instagram.com/seurestaurante">
                    </div>
                    <div>
                        <label for="social-twitter" class="block text-slate-700 text-sm font-bold mb-2">Twitter URL:</label>
                        <input type="url" id="social-twitter" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="https://twitter.com/seurestaurante">
                    </div>
                    <div>
                        <label for="social-whatsapp" class="block text-slate-700 text-sm font-bold mb-2">WhatsApp Contato (número com DDD):</label>
                        <input type="text" id="social-whatsapp" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="+5511987654321">
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Links</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Seção Frete -->
        <section id="shipping" class="content-section hidden">
            <p class="text-slate-600 mb-6">Configure as opções de frete para seu restaurante. Escolha entre frete por raio, fixo ou grátis a partir de um valor.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Configuração de Frete</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-slate-700 text-sm font-bold mb-2">Modelo de Frete:</label>
                        <div class="flex items-center space-x-4">
                            <label class="inline-flex items-center">
                                <input type="radio" name="shipping-model" value="radius" class="form-radio text-indigo-600" checked>
                                <span class="ml-2 text-slate-700">Por Raio (Distância)</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="shipping-model" value="fixed" class="form-radio text-indigo-600">
                                <span class="ml-2 text-slate-700">Valor Fixo</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="radio" name="shipping-model" value="free-min-order" class="form-radio text-indigo-600">
                                <span class="ml-2 text-slate-700">Grátis acima de Valor</span>
                            </label>
                        </div>
                    </div>

                    <div id="shipping-radius-config" class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="font-semibold text-slate-800 mb-2">Frete por Raio</h4>
                        <p class="text-slate-600 text-sm mb-3">Defina o custo de entrega por distância do restaurante.</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="radius-km" class="block text-slate-700 text-sm font-bold mb-2">Raio de Cobertura (Km):</label>
                                <input type="number" id="radius-km" step="0.5" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="5">
                            </div>
                            <div>
                                <label for="cost-per-km" class="block text-slate-700 text-sm font-bold mb-2">Custo por Km (R$):</label>
                                <input type="number" id="cost-per-km" step="0.1" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="2.00">
                            </div>
                        </div>
                    </div>

                    <div id="shipping-fixed-config" class="hidden bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="font-semibold text-slate-800 mb-2">Frete Fixo</h4>
                        <p class="text-slate-600 text-sm mb-3">Defina um valor fixo para todas as entregas dentro da sua área.</p>
                        <div>
                            <label for="fixed-shipping-cost" class="block text-slate-700 text-sm font-bold mb-2">Valor Fixo (R$):</label>
                            <input type="number" id="fixed-shipping-cost" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="8.00">
                        </div>
                    </div>

                    <div id="shipping-free-min-order-config" class="hidden bg-slate-50 p-4 rounded-lg border border-slate-200">
                        <h4 class="font-semibold text-slate-800 mb-2">Frete Grátis Acima de Valor</h4>
                        <p class="text-slate-600 text-sm mb-3">Defina um valor mínimo de pedido para o frete ser grátis. Caso contrário, o frete fixo padrão será aplicado.</p>
                        <div>
                            <label for="free-shipping-min-value" class="block text-slate-700 text-sm font-bold mb-2">Valor Mínimo (R$):</label>
                            <input type="number" id="free-shipping-min-value" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="100.00">
                        </div>
                    </div>

                    <div class="mt-4">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Configurações de Frete</button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Seção Gerenciamento IA WhatsApp -->
        <section id="ia-whatsapp-management" class="content-section hidden">
            <p class="text-slate-600 mb-6">Gerencie as configurações e o comportamento do seu Agente de IA no WhatsApp.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Configurações do Agente IA</h3>
                <form id="ia-whatsapp-config-form" class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="ia-welcome-message-active" class="form-checkbox text-teal-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Mensagem de Boas-Vindas Automática</span>
                        </label>
                    </div>
                    <div>
                        <label for="ia-welcome-message-text" class="block text-slate-700 text-sm font-bold mb-2">Mensagem de Boas-Vindas:</label>
                        <textarea id="ia-welcome-message-text" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline h-20">Olá! Bem-vindo(a) à nossa plataforma de delivery via WhatsApp. Como posso ajudar hoje?</textarea>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="ia-faq-active" class="form-checkbox text-teal-600" checked>
                            <span class="ml-2 text-slate-700">Ativar Respostas Automáticas para FAQs</span>
                        </label>
                    </div>
                    <div>
                        <label class="inline-flex items-center">
                            <input type="checkbox" id="ia-proactive-alerts-active" class="form-checkbox text-teal-600">
                            <span class="ml-2 text-slate-700">Ativar Alertas Proativos (ex: pedidos atrasados)</span>
                        </label>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Configurações IA</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Seção Tracking de Pedidos -->
        <section id="tracking" class="content-section hidden">
            <p class="text-slate-600 mb-6">Acompanhe em tempo real a localização e o status de entrega dos seus entregadores próprios.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Mapa de Entregadores</h3>
                <div class="map-placeholder w-full h-96 rounded-lg text-slate-500 text-lg">
                    [Image of Mapa com motoristas e rotas simuladas]
                </div>
                <div class="mt-6">
                    <h4 class="text-lg font-semibold text-slate-800 mb-3">Entregadores Ativos</h4>
                    <ul class="list-disc list-inside text-slate-600 space-y-2">
                        <li>Entregador 1: Em rota para Pedido #DRZ789 (Localização: Rua Alfa, 123)</li>
                        <li>Entregador 2: Disponível (Localização: No restaurante)</li>
                        <li>Entregador 3: Em rota para Pedido #DRZ790 (Localização: Av. Beta, 45)</li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Seção Comunicação -->
        <section id="communication" class="content-section hidden">
            <p class="text-slate-600 mb-6">Gerencie templates de mensagens personalizadas para se comunicar com seus clientes através do chat dos pedidos.</p>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200 mb-6">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Templates de Mensagens</h3>
                <form id="message-template-form" class="grid grid-cols-1 gap-4">
                    <div>
                        <label for="template-name" class="block text-slate-700 text-sm font-bold mb-2">Nome do Template:</label>
                        <input type="text" id="template-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Atraso na Entrega" required>
                    </div>
                    <div>
                        <label for="template-text" class="block text-slate-700 text-sm font-bold mb-2">Texto da Mensagem:</label>
                        <textarea id="template-text" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline h-24" placeholder="Olá [Cliente], seu pedido #[Pedido] pode atrasar um pouco devido a [Motivo]. Pedimos desculpas!" required></textarea>
                    </div>
                    <div class="mt-4">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Template</button>
                    </div>
                </form>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <h3 class="text-xl font-bold text-slate-800 mb-4">Meus Templates</h3>
                <div id="message-templates-list" class="space-y-4">
                    <!-- Templates serão carregados aqui -->
                </div>
            </div>
        </section>

        <!-- Seção Perguntas Frequentes -->
        <section id="faq" class="content-section hidden">
            <p class="text-slate-600 mb-6">Encontre respostas para as perguntas mais comuns sobre a plataforma, pedidos, finanças e como otimizar suas vendas.</p>
            <div id="faq-accordion" class="space-y-4 bg-white p-6 rounded-lg shadow-md border border-slate-200">
                <!-- FAQ items will be loaded here -->
            </div>
        </section>

    </main>

    <!-- Modal de Edição de Item -->
    <div id="edit-item-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-md mx-auto">
            <h3 class="text-2xl font-bold text-slate-900 mb-6">Editar Item do Cardápio</h3>
            <form id="edit-item-form" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="edit-item-id">
                <div>
                    <label for="edit-item-name" class="block text-slate-700 text-sm font-bold mb-2">Nome do Item:</label>
                    <input type="text" id="edit-item-name" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div>
                    <label for="edit-item-category" class="block text-slate-700 text-sm font-bold mb-2">Categoria:</label>
                    <select id="edit-item-category" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                        <option value="Pizzas">Pizzas</option>
                        <option value="Hambúrgueres">Hambúrgueres</option>
                        <option value="Sushi">Sushi</option>
                        <option value="Sobremesas">Sobremesas</option>
                        <option value="Bebidas">Bebidas</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div>
                    <label for="edit-item-price" class="block text-slate-700 text-sm font-bold mb-2">Preço:</label>
                    <input type="number" id="edit-item-price" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" required>
                </div>
                <div id="edit-pizza-flavors-input-group" class="hidden">
                    <label for="edit-item-flavors" class="block text-slate-700 text-sm font-bold mb-2">Sabores (separados por vírgula):</label>
                    <input type="text" id="edit-item-flavors" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="edit-item-promo-price" class="block text-slate-700 text-sm font-bold mb-2">Preço Promocional (Opcional):</label>
                    <input type="number" id="edit-item-promo-price" step="0.01" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div>
                    <label for="edit-item-description" class="block text-slate-700 text-sm font-bold mb-2">Descrição:</label>
                    <textarea id="edit-item-description" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline h-20"></textarea>
                </div>
                <div>
                    <label for="edit-item-image" class="block text-slate-700 text-sm font-bold mb-2">URL da Imagem:</label>
                    <input type="text" id="edit-item-image" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline">
                </div>
                <div class="flex items-center space-x-4">
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="edit-item-active" class="form-checkbox text-teal-600">
                        <span class="ml-2 text-slate-700">Disponível para venda</span>
                    </label>
                    <label class="inline-flex items-center">
                        <input type="checkbox" id="edit-item-promo-toggle" class="form-checkbox text-indigo-600">
                        <span class="ml-2 text-slate-700">Aplicar Promoção</span>
                    </label>
                </div>
                <div class="flex justify-end space-x-4 mt-6">
                    <button type="button" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition" onclick="closeEditModal()">Cancelar</button>
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Chat com Cliente -->
    <div id="chat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-md mx-auto flex flex-col h-[70vh]">
            <div class="flex justify-between items-center pb-4 border-b border-slate-200 mb-4">
                <h3 class="text-xl font-bold text-slate-900">Chat com <span id="chat-client-name"></span> (Pedido #<span id="chat-order-id"></span>)</h3>
                <button class="text-slate-500 hover:text-slate-700" onclick="closeChatModal()">✖️</button>
            </div>
            <div id="chat-messages-content" class="flex-grow overflow-y-auto space-y-3 mb-4 p-2 bg-slate-50 rounded-lg">
                <!-- Mensagens do chat aqui -->
            </div>
            <div id="ai-suggestions-container" class="mb-3 space-y-2">
                <!-- Sugestões da IA aqui -->
                <button type="button" id="generate-chat-suggestion-btn" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-lg transition">Gerar Sugestões de Resposta ✨</button>
            </div>
            <textarea id="chat-input-text" class="shadow appearance-none border rounded w-full py-2 px-3 text-slate-700 leading-tight focus:outline-none focus:shadow-outline h-20 mb-3" placeholder="Digite sua mensagem aqui..."></textarea>
            <div class="flex justify-end">
                <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg focus:outline-none focus:shadow-outline transition" onclick="sendMessage()">Enviar Mensagem</button>
            </div>
        </div>
    </div>

    <!-- Generic Custom Modal Structure (for alerts and confirms) -->
    <div id="custom-alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-[1001]">
        <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm mx-auto">
            <h3 id="custom-alert-title" class="text-xl font-bold text-slate-900 mb-4"></h3>
            <p id="custom-alert-message" class="text-slate-700 mb-6"></p>
            <div id="custom-alert-buttons" class="flex justify-end space-x-3">
                <button id="custom-alert-cancel" class="bg-slate-300 hover:bg-slate-400 text-slate-800 font-bold py-2 px-4 rounded-lg transition hidden">Cancelar</button>
                <button id="custom-alert-ok" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg transition">OK</button>
            </div>
        </div>
    </div>

    <script type="module">
        // Importa as funções necessárias do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, collection, query, onSnapshot, addDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Variáveis globais do ambiente Canvas (preenchidas em tempo de execução)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // ID do usuário logado ou anônimo
        let isAuthReady = false; // Flag para indicar se a autenticação foi concluída

        // Observa o estado da autenticação
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                console.log("Usuário autenticado:", userId);
            } else {
                try {
                    // Tenta fazer login com o token personalizado se disponível, caso contrário, anonimamente
                    if (typeof __initial_auth_token !== 'undefined') {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    userId = auth.currentUser?.uid || crypto.randomUUID(); // Fallback para userId se anônimo
                    console.log("Login anônimo/customizado bem-sucedido. User ID:", userId);
                } catch (error) {
                    console.error("Erro na autenticação Firebase:", error);
                    showAlert("Erro ao autenticar no sistema. Por favor, recarregue a página.", "Erro de Autenticação");
                    userId = 'anonymous'; // Fallback em caso de erro na autenticação
                }
            }
            isAuthReady = true;
            // Uma vez autenticado, carregue os dados
            if (userId) {
                loadInitialData();
            }
        });

        // Funções auxiliares para referências do Firestore
        function getUserDocRef() {
            if (!userId) {
                console.error("User ID não disponível para obter User Doc Ref.");
                return null;
            }
            return doc(db, `artifacts/${appId}/users/${userId}`);
        }

        function getCollectionRef(collectionName) {
            if (!userId) {
                console.error("User ID não disponível para obter Collection Ref.");
                return null;
            }
            return collection(db, `artifacts/${appId}/users/${userId}/${collectionName}`);
        }

        function getDocRef(collectionName, docId) {
            if (!userId) {
                console.error("User ID não disponível para obter Doc Ref.");
                return null;
            }
            return doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);
        }

        // Variáveis para o modal personalizado de alerta/confirmação
        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertTitle = document.getElementById('custom-alert-title');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkButton = document.getElementById('custom-alert-ok');
        const customAlertCancelButton = document.getElementById('custom-alert-cancel');
        
        /**
         * Exibe um modal de alerta personalizado.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} title - O título do modal.
         * @returns {Promise<boolean>} - Uma promessa que resolve para true quando o botão OK é clicado.
         */
        function showAlert(message, title = 'Notificação') {
            return new Promise(resolve => {
                customAlertTitle.textContent = title;
                customAlertMessage.textContent = message;
                customAlertCancelButton.classList.add('hidden'); // Oculta o botão Cancelar para alertas
                customAlertOkButton.textContent = 'OK';

                customAlertOkButton.onclick = () => {
                    customAlertModal.classList.add('hidden');
                    resolve(true);
                };

                customAlertModal.classList.remove('hidden');
            });
        }

        /**
         * Exibe um modal de confirmação personalizado.
         * @param {string} message - A mensagem a ser exibida.
         * @param {string} title - O título do modal.
         * @returns {Promise<boolean>} - Uma promessa que resolve para true se Confirmar for clicado, false se Cancelar.
         */
        function showConfirm(message, title = 'Confirmação') {
            return new Promise(resolve => {
                customAlertTitle.textContent = title;
                customAlertMessage.textContent = message;
                customAlertCancelButton.classList.remove('hidden'); // Exibe o botão Cancelar para confirmações
                customAlertOkButton.textContent = 'Confirmar';

                customAlertOkButton.onclick = () => {
                    customAlertModal.classList.add('hidden');
                    resolve(true);
                };

                customAlertCancelButton.onclick = () => {
                    customAlertModal.classList.add('hidden');
                    resolve(false);
                };

                customAlertModal.classList.remove('hidden');
            });
        }


        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.content-section');
        const mainTitle = document.getElementById('main-title');

        const salesChartCtx = document.getElementById('salesChart').getContext('2d');
        let salesChart;

        const menuItemsList = document.getElementById('menu-items-list');
        const addMenuItemForm = document.getElementById('add-item-form');
        const editItemModal = document.getElementById('edit-item-modal');
        const editItemForm = document.getElementById('edit-item-form');
        const itemCategorySelect = document.getElementById('item-category');
        const pizzaFlavorsInputGroup = document.getElementById('pizza-flavors-input-group');
        const editItemCategorySelect = document.getElementById('edit-item-category');
        const editPizzaFlavorsInputGroup = document.getElementById('edit-pizza-flavors-input-group');
        const generateDescriptionBtn = document.getElementById('generate-description-btn');


        const ordersTabList = document.getElementById('orders-tab-list');
        const ordersTabKds = document.getElementById('orders-tab-kds');
        const ordersListView = document.getElementById('orders-list-view');
        const ordersKdsView = document.getElementById('orders-kds-view');
        const kdsOrdersGrid = document.getElementById('kds-orders-grid');


        const activeOrdersList = document.getElementById('active-orders-list');
        const orderHistoryList = document.getElementById('order-history-list');
        const newOrdersCount = document.getElementById('new-orders-count');
        const pauseNowButton = document.getElementById('pause-now-button');


        const addCouponForm = document.getElementById('add-coupon-form');
        const couponList = document.getElementById('coupon-list');
        
        const operatingHoursConfig = document.getElementById('operating-hours-config');
        const addHourSlotButton = document.getElementById('add-hour-slot');
        const paymentMethodsConfig = document.getElementById('payment-methods-config');
        const storeStatusRadios = document.querySelectorAll('input[name="store-status"]');
        const scheduleCloseOptions = document.getElementById('schedule-close-options');

        const moduleNotificationsToggle = document.getElementById('module-notifications'); // New toggle
        const modulePackagingToggle = document.getElementById('module-packaging');
        const moduleBudgetToggle = document.getElementById('module-budget');
        const moduleScheduledDeliveryToggle = document.getElementById('module-scheduled-delivery');
        const moduleSocialMediaToggle = document.getElementById('module-social-media');
        const moduleIaWhatsappMgmtToggle = document.getElementById('module-ia-whatsapp-mgmt');
        const moduleShippingRatesToggle = document.getElementById('module-shipping-rates');
        const modulePrintCommandToggle = document.getElementById('module-print-command');
        const moduleTrackingToggle = document.getElementById('module-tracking');
        const moduleCommunicationToggle = document.getElementById('module-communication');
        const moduleCashflowToggle = document.getElementById('module-cashflow');


        const sidebarPackagingLinkContainer = document.getElementById('sidebar-packaging-link-container');
        const sidebarBudgetLinkContainer = document.getElementById('sidebar-budget-link-container');
        const sidebarSocialMediaLinkContainer = document.getElementById('sidebar-social-media-link-container');
        const sidebarShippingLinkContainer = document.getElementById('sidebar-shipping-link-container');
        const sidebarIaWhatsappMgmtLinkContainer = document.getElementById('sidebar-ia-whatsapp-mgmt-link-container');
        const sidebarTrackingLinkContainer = document.getElementById('sidebar-tracking-link-container');
        const sidebarCommunicationLinkContainer = document.getElementById('sidebar-communication-link-container');
        const cashflowModuleContainer = document.getElementById('cashflow-module-container');


        const packagingForm = document.getElementById('packaging-form');
        const packagingList = document.getElementById('packaging-list');

        const budgetRequestsList = document.getElementById('budget-requests-list');

        const socialMediaForm = document.getElementById('social-media-form');

        const shippingModelRadios = document.querySelectorAll('input[name="shipping-model"]');
        const shippingRadiusConfig = document.getElementById('shipping-radius-config');
        const shippingFixedConfig = document.getElementById('shipping-fixed-config');
        const shippingFreeMinOrderConfig = document.getElementById('shipping-free-min-order-config');

        const iaWhatsappConfigForm = document.getElementById('ia-whatsapp-config-form');

        const messageTemplateForm = document.getElementById('message-template-form');
        const messageTemplatesList = document.getElementById('message-templates-list');


        const cashflowForm = document.getElementById('cashflow-form');
        const transactionsList = document.getElementById('transactions-list');
        const currentBalanceDisplay = document.getElementById('current-balance');
        const cashflowChartCtx = document.getElementById('cashflowChart').getContext('2d');
        let cashflowChart;

        const dailyCashModuleContainer = document.getElementById('daily-cash-module-container');
        const dailyCashStatusDisplay = document.getElementById('daily-cash-status');
        const dailyCashOpeningBalanceDisplay = document.getElementById('daily-cash-opening-balance');
        const dailyCashCurrentBalanceDisplay = document.getElementById('daily-cash-current-balance');
        const dailyCashTotalInDisplay = document.getElementById('daily-cash-total-in');
        const dailyCashTotalOutDisplay = document.getElementById('daily-cash-total-out');
        const openCashBtn = document.getElementById('open-cash-btn');
        const closeCashBtn = document.getElementById('close-cash-btn');
        const addCashMovementBtn = document.getElementById('add-cash-movement-btn');
        const dailyCashMovementsList = document.getElementById('daily-cash-movements-list');


        const generatePromoIdeasBtn = document.getElementById('generate-promo-ideas-btn');
        const promotionIdeasOutput = document.getElementById('promotion-ideas-output');


        const faqAccordion = document.getElementById('faq-accordion');
        const salesGrowthAccordion = document.getElementById('sales-growth-accordion');
        const reviewsList = document.getElementById('reviews-list');

        // Chat Modal Elements
        const chatModal = document.getElementById('chat-modal');
        const chatClientName = document.getElementById('chat-client-name');
        const chatOrderId = document.getElementById('chat-order-id');
        const chatMessagesContent = document.getElementById('chat-messages-content');
        const chatInputText = document.getElementById('chat-input-text');
        const generateChatSuggestionBtn = document.getElementById('generate-chat-suggestion-btn');
        const aiSuggestionsContainer = document.getElementById('ai-suggestions-container');

        let currentChatOrderId = null;

        // Estrutura de dados inicial (será preenchida pelo Firestore)
        const data = {
            menuItems: [],
            orders: [],
            coupons: [],
            operatingHours: [],
            paymentMethods: [],
            reviews: [],
            faq: [
                { question: 'Como faço para cancelar pedidos?', answer: 'Lembre-se de que cancelar pedidos cria uma imagem negativa do seu restaurante. Se o cancelamento for mesmo necessário, entre em contato com o Suporte da plataforma, informando o número do pedido e o motivo do cancelamento. Sua solicitação será avaliada e respondida rapidamente.' },
                { question: 'Quanto tempo tenho para confirmar um pedido?', answer: 'Você tem 4 minutos para confirmar um pedido. Caso não o faça, ele será automaticamente cancelado pela plataforma. Pedidos cancelados automaticamente não devem ser entregues, pois o cliente não estará mais aguardando.' },
                { question: 'O que fazer se recebi dois pedidos idênticos?', answer: 'Primeiro, verifique se foram feitos pela mesma pessoa, num curto espaço de tempo, com mesmo valor e itens. Se for o caso, entre em contato com o Suporte da plataforma, informando o número do pedido a ser cancelado por duplicidade. A equipe avaliará sua solicitação.' },
                { question: 'Recebi um pedido em área de entrega que não atendo, o que faço?', answer: 'Assim que receber o pedido, entre em contato com o Suporte da plataforma para que o problema seja resolvido o quanto antes e o pedido possa ser cancelado ou reencaminhado.' },
                { question: 'Como estornar valores pagos no cartão de crédito por meio da plataforma?', answer: 'Para pedidos pagos com cartão online, procure no pedido as informações sobre o pagamento. Entre em contato com a operadora do cartão de crédito informando: número de autorização, bandeira, data, hora, valor e números iniciais e finais do cartão.' },
                { question: 'Tenho dúvidas sobre os valores da minha fatura. Com quem devo falar?', answer: 'Entre em contato com o Suporte da plataforma, informando qual a divergência. Seu pedido será encaminhado ao setor financeiro, que entrará em contato para avaliar e solucionar a questão.' },
                { question: 'Cancelei pedidos e ele me foi cobrado na fatura. Por quê?', answer: 'Os pedidos devem ser cancelados dentro do mês vigente para evitar a cobrança da comissão. Caso sejam cancelados após esse período, os valores da comissão serão revertidos em créditos na sua próxima fatura.' },
                { question: 'Como faço para colocar o link da plataforma no site do meu restaurante?', answer: 'É preciso entrar em contato com o Suporte da plataforma por e-mail ou telefone e fazer a solicitação. Nossa equipe entrará em contato para dar andamento ao seu pedido e orientar sobre a integração.' },
                { question: 'Quero fazer uma promoção exclusiva para a plataforma. Como fazer?', answer: 'Fale com o Suporte da plataforma por e-mail ou telefone. Você receberá de nossa equipe todas as informações necessárias para criar e ativar sua promoção exclusiva.' },
                { question: 'Minha máquina POS está com a mensagem “registrando”. O que faço?', answer: 'Tire a máquina da tomada e volte a ligá-la em 15 segundos. Se o problema persistir, entre em contato com o suporte da plataforma.' },
                { question: 'Porque meu restaurante aparece fechado na plataforma?', answer: 'Pode ser por problemas de sinal da máquina POS/internet, falta de bobina de impressão, você pode ter solicitado o fechamento ou fechado pela extranet e não reabriu. Verifique esses pontos e, se persistir, contate o suporte.' },
                { question: 'Preciso alterar minha área e taxas de entrega. Como proceder?', answer: 'Entre em contato com o Suporte da plataforma por telefone ou e-mail para solicitar as atualizações da sua área de entrega e das taxas associadas. Nossa equipe irá ajudá-lo a configurar corretamente.' },
                { question: 'Meus dados da loja mudaram (dono, CNPJ, razão social, endereço, e-mail financeiro). Como atualizar?', answer: 'Entre em contato com o Suporte da plataforma por telefone ou e-mail para solicitar as atualizações dos dados cadastrais da sua loja. É crucial manter essas informações sempre atualizadas para a correta operação e comunicação.' },
                { question: 'Como funciona a avaliação do meu restaurante pelos clientes?', answer: 'Para cada pedido realizado, a plataforma envia um e-mail ao cliente solicitando uma avaliação. As notas são consolidadas e apresentadas para o seu restaurante. A área de SAC da plataforma encaminha reclamações e elogios para seu contato.' },
                { question: 'Recebi uma avaliação ruim e gostaria de apagar. É possível?', answer: 'A plataforma não pode excluir avaliações dadas pelos usuários. Para garantir a veracidade das informações, as notas de clientes são mantidas. Foco em melhorar o serviço para futuras avaliações.' }
            ],
            salesGrowthTips: [
                { title: 'Apareça na Frente dos Concorrentes', content: 'A plataforma lista os restaurantes de acordo com a avaliação dos usuários. Uma boa avaliação garante uma posição no topo da listagem de estabelecimentos em sua região. O melhor marketing é um bom atendimento ao cliente. Mais de 70% das vendas da plataforma são para os 20 primeiros colocados (exibidos por CEP).' },
                { title: 'Ajuste o Horário de Funcionamento', content: 'Um horário de funcionamento limitado diminui consideravelmente os pedidos. Certifique-se de que seu restaurante esteja online dentro do seu horário de funcionamento para receber pedidos. Acesse a Extranet para validar e atualizar seus horários.' },
                { title: 'Ajuste a Área de Entrega', content: 'Se sua área de entrega é pequena, o número de clientes atendidos será limitado, impactando o potencial de vendas. Defina a área de acordo com sua capacidade de entregar no prazo e com qualidade. Entre em contato com o Suporte para atualizar sua área de entrega.' },
                { title: 'Otimize Seu Cardápio', content: 'Otimizar o cardápio para o ambiente online é essencial. Exclua itens com poucas vendas, adicione sobremesas e bebidas para aumentar o ticket médio, crie categorias para os pratos mais vendidos e utilize fotos reais e de boa qualidade. Acesse a Extranet para editar.' },
                { title: 'Faça Promoções', content: 'As promoções são destacadas na plataforma e no topo do seu cardápio. Quanto melhor a promoção, melhores os resultados. Considere descontos de cerca de 30% e sempre inclua fotos. Exemplos de sucesso: "Pague 1 Leve 2", descontos agressivos, e itens exclusivos para a plataforma. Acesse a Extranet ou o Suporte para criar promoções.' },
                { title: 'Amplie as Formas de Pagamento', content: 'Poucas opções de pagamento podem fazer clientes desistirem do pedido. Ter diversas opções, como cartão de crédito/débito online e Pix, aumenta a chance de venda. 60% dos pedidos na plataforma são pagos com cartão. Defina um valor razoável para o pedido mínimo.' },
                { title: 'Coloque o Link da Plataforma no Seu Site', content: 'Se você tem um site, adicione um link de destaque para o seu cardápio na plataforma. Isso direciona clientes diretamente para o pedido e pode gerar até 100 pedidos a cada 1.000 visitas. Converse com seu representante para saber sobre isenção de comissão para pedidos vindos do seu link.' },
                { title: 'A Plataforma Divulga Seu Restaurante', content: 'A plataforma divulga seu restaurante para toda a sua base de clientes via Push Notifications, Newsletter, redes sociais (Twitter, Facebook), Mala Direta e Anúncios no Google. Tenha boa avaliação e promoções relevantes para conseguir essa divulgação.' },
                { title: 'Divulgue Seu Restaurante', content: 'Em seu material de marketing (cardápio de delivery, folders), inclua o logo da plataforma e solicite a avaliação dos clientes para os pedidos online. Para ações conjuntas com a plataforma, contate a área de Vendas.' },
                { title: 'Operando Seu Delivery Online', content: 'O atendente do delivery coordena as atividades: iniciar o sistema, conferir materiais de marketing, checar produtos disponíveis. Acompanhar a produção, gerenciar tempo de entrega, providenciar nota fiscal, montar pedido e entregar ao motoboy. Concluir o pedido e conferir recebimento de valores. Manter contato com o cliente em caso de atrasos.' },
                { title: 'Qualifique Seu Atendimento', content: 'Seu atendente deve saber receber pedidos, marcar itens em falta, alterar tempo de entrega, inativar pagamentos, alterar horário, fechar loja, cancelar pedidos, acessar suporte e solucionar problemas. O gerente deve revalidar mensalmente cardápio, promoções, horários, áreas de entrega e taxas, e treinar a equipe.' },
                { title: 'Evite Prejuízos', content: 'Lide com trotes informando ao suporte. Para pedidos de alto valor (ex: acima de R$150), confirme com o cliente por telefone antes do preparo. No primeiro pedido de um novo cliente, entre em contato para confirmar dados e evitar prejuízos, além de aumentar a chance de recompra.' }
            ],
            packaging: [],
            budgetRequests: [],
            socialMedia: {},
            shippingRates: {},
            iaWhatsappConfig: {},
            cashflow: { balance: 0, transactions: [], chartData: { labels: [], revenues: [], expenses: [] } },
            dailyCash: { isOpen: false, openingBalance: 0, currentBalance: 0, totalIn: 0, totalOut: 0, movements: [] },
            messageTemplates: [],
            settings: {
                notificationsActive: true, // New setting
                modules: {
                    packaging: true,
                    budget: true,
                    scheduledDelivery: true,
                    socialMedia: true,
                    iaWhatsappMgmt: true,
                    shippingRates: true,
                    printCommand: true,
                    tracking: true,
                    communication: true,
                    cashflow: true
                }
            },
            notifiedEvents: new Set() // Store IDs of events for which notifications have been shown
        };

        // Função para carregar os dados iniciais do Firestore
        async function loadInitialData() {
            if (!isAuthReady) {
                console.warn("Autenticação não concluída. Tentando carregar dados novamente em breve...");
                setTimeout(loadInitialData, 500); // Tenta novamente após um pequeno atraso
                return;
            }

            // Load settings first, as they control module visibility
            const settingsDocRef = getUserDocRef();
            if (settingsDocRef) {
                onSnapshot(settingsDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(data.settings, docSnap.data().settings || {});
                        updateModuleVisibility();
                        // Re-render sections that depend on settings immediately
                        if (!document.getElementById('financial').classList.contains('hidden')) {
                            renderFinancial();
                        }
                        if (!document.getElementById('settings').classList.contains('hidden')) {
                            renderSettings();
                        }
                    } else {
                        // Initialize default settings if no document exists
                        setDoc(settingsDocRef, { settings: data.settings }, { merge: true });
                    }
                }, (error) => {
                    console.error("Erro ao carregar configurações:", error);
                    showAlert("Erro ao carregar configurações: " + error.message, "Erro de Dados");
                });
            }

            // Load Menu Items
            const menuItemsColRef = getCollectionRef('menuItems');
            if (menuItemsColRef) {
                onSnapshot(menuItemsColRef, (snapshot) => {
                    data.menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('menu').classList.contains('hidden')) {
                        renderMenuItems();
                    }
                }, (error) => {
                    console.error("Erro ao carregar itens do cardápio:", error);
                    showAlert("Erro ao carregar cardápio: " + error.message, "Erro de Dados");
                });
            }

            // Load Orders
            const ordersColRef = getCollectionRef('orders');
            if (ordersColRef) {
                 onSnapshot(query(ordersColRef, orderBy('timestamp', 'desc')), (snapshot) => { // Order by timestamp
                    const oldOrders = new Set(data.orders.map(o => o.id)); // Track existing orders
                    data.orders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                    // Detect new orders and cancellations for notifications
                    data.orders.forEach(order => {
                        if (!oldOrders.has(order.id) && order.status === 'Confirmado') {
                            if (data.settings.notificationsActive) {
                                showToastNotification(`Novo pedido recebido: #${order.id} de ${order.customer}!`, 'info', `new-order-${order.id}`);
                            }
                        } else if (oldOrders.has(order.id)) {
                             const oldOrder = data.orders.find(o => o.id === order.id); // Find old version in the updated data
                             if (oldOrder && oldOrder.status !== 'Cancelado' && order.status === 'Cancelado') {
                                 if (data.settings.notificationsActive) {
                                     showToastNotification(`Pedido #${order.id} foi cancelado!`, 'error', `order-cancel-${order.id}`);
                                 }
                             }
                        }
                    });

                    if (!document.getElementById('orders').classList.contains('hidden') || !document.getElementById('dashboard').classList.contains('hidden')) {
                         renderOrders();
                         updateDashboardMetrics();
                    }
                }, (error) => {
                    console.error("Erro ao carregar pedidos:", error);
                    showAlert("Erro ao carregar pedidos: " + error.message, "Erro de Dados");
                });
            }

            // Load Coupons
            const couponsColRef = getCollectionRef('coupons');
            if (couponsColRef) {
                onSnapshot(couponsColRef, (snapshot) => {
                    data.coupons = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('coupons').classList.contains('hidden')) {
                        renderCoupons();
                    }
                }, (error) => {
                    console.error("Erro ao carregar cupons:", error);
                    showAlert("Erro ao carregar cupons: " + error.message, "Erro de Dados");
                });
            }

            // Load Operating Hours
            const operatingHoursColRef = getCollectionRef('operatingHours');
            if (operatingHoursColRef) {
                onSnapshot(operatingHoursColRef, (snapshot) => {
                    data.operatingHours = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('settings').classList.contains('hidden')) {
                        renderOperatingHours();
                    }
                }, (error) => {
                    console.error("Erro ao carregar horários de funcionamento:", error);
                    showAlert("Erro ao carregar horários: " + error.message, "Erro de Dados");
                });
            }

            // Load Payment Methods
            const paymentMethodsColRef = getCollectionRef('paymentMethods');
            if (paymentMethodsColRef) {
                onSnapshot(paymentMethodsColRef, (snapshot) => {
                    data.paymentMethods = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('settings').classList.contains('hidden')) {
                        renderPaymentMethods();
                    }
                }, (error) => {
                    console.error("Erro ao carregar métodos de pagamento:", error);
                    showAlert("Erro ao carregar pagamentos: " + error.message, "Erro de Dados");
                });
            }

            // Load Reviews
            const reviewsColRef = getCollectionRef('reviews');
            if (reviewsColRef) {
                onSnapshot(reviewsColRef, (snapshot) => {
                    data.reviews = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('reviews').classList.contains('hidden') || !document.getElementById('dashboard').classList.contains('hidden')) {
                         renderReviews();
                         updateDashboardMetrics();
                    }
                }, (error) => {
                    console.error("Erro ao carregar avaliações:", error);
                    showAlert("Erro ao carregar avaliações: " + error.message, "Erro de Dados");
                });
            }

            // Load Packaging
            const packagingColRef = getCollectionRef('packaging');
            if (packagingColRef) {
                onSnapshot(packagingColRef, (snapshot) => {
                    data.packaging = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('packaging').classList.contains('hidden')) {
                        renderPackaging();
                    }
                }, (error) => {
                    console.error("Erro ao carregar embalagens:", error);
                    showAlert("Erro ao carregar embalagens: " + error.message, "Erro de Dados");
                });
            }

            // Load Budget Requests
            const budgetRequestsColRef = getCollectionRef('budgetRequests');
            if (budgetRequestsColRef) {
                onSnapshot(budgetRequestsColRef, (snapshot) => {
                    data.budgetRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('budget').classList.contains('hidden')) {
                        renderBudgetRequests();
                    }
                }, (error) => {
                    console.error("Erro ao carregar orçamentos:", error);
                    showAlert("Erro ao carregar orçamentos: " + error.message, "Erro de Dados");
                });
            }

            // Load Social Media
            const socialMediaDocRef = doc(getUserDocRef(), 'socialMedia');
            if (socialMediaDocRef) {
                onSnapshot(socialMediaDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(data.socialMedia, docSnap.data());
                        if (!document.getElementById('social-media').classList.contains('hidden')) {
                            renderSocialMediaSettings();
                        }
                    } else {
                        setDoc(socialMediaDocRef, { facebook: '', instagram: '', twitter: '', whatsapp: '' }); // Initialize
                    }
                }, (error) => {
                    console.error("Erro ao carregar redes sociais:", error);
                    showAlert("Erro ao carregar redes sociais: " + error.message, "Erro de Dados");
                });
            }

            // Load Shipping Rates
            const shippingRatesDocRef = doc(getUserDocRef(), 'shippingRates');
            if (shippingRatesDocRef) {
                onSnapshot(shippingRatesDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(data.shippingRates, docSnap.data());
                        if (!document.getElementById('shipping').classList.contains('hidden')) {
                            renderShippingSettings();
                        }
                    } else {
                        setDoc(shippingRatesDocRef, { model: 'radius', radius: { km: 5, costPerKm: 2.00 }, fixed: { cost: 8.00 }, freeMinOrder: { value: 100.00 } }); // Initialize
                    }
                }, (error) => {
                    console.error("Erro ao carregar frete:", error);
                    showAlert("Erro ao carregar frete: " + error.message, "Erro de Dados");
                });
            }

            // Load IA WhatsApp Config
            const iaWhatsappConfigDocRef = doc(getUserDocRef(), 'iaWhatsappConfig');
            if (iaWhatsappConfigDocRef) {
                onSnapshot(iaWhatsappConfigDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(data.iaWhatsappConfig, docSnap.data());
                        if (!document.getElementById('ia-whatsapp-management').classList.contains('hidden')) {
                            renderIaWhatsappManagement();
                        }
                    } else {
                        setDoc(iaWhatsappConfigDocRef, { welcomeMessageActive: true, welcomeMessageText: 'Olá! Bem-vindo(a) à nossa plataforma de delivery via WhatsApp. Como posso ajudar hoje?', faqActive: true, proactiveAlertsActive: false }); // Initialize
                    }
                }, (error) => {
                    console.error("Erro ao carregar config IA WhatsApp:", error);
                    showAlert("Erro ao carregar config IA WhatsApp: " + error.message, "Erro de Dados");
                });
            }

            // Load Cashflow
            const cashflowDocRef = doc(getUserDocRef(), 'cashflow');
            if (cashflowDocRef) {
                onSnapshot(cashflowDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(data.cashflow, docSnap.data());
                        // Ensure chartData properties are initialized if missing
                        data.cashflow.chartData = data.cashflow.chartData || { labels: [], revenues: [], expenses: [] };
                        if (!document.getElementById('financial').classList.contains('hidden') && data.settings.modules.cashflow) {
                            renderCashflow();
                        }
                    } else {
                        setDoc(cashflowDocRef, { balance: 0, transactions: [], chartData: { labels: [], revenues: [], expenses: [] } }); // Initialize
                    }
                }, (error) => {
                    console.error("Erro ao carregar fluxo de caixa:", error);
                    showAlert("Erro ao carregar fluxo de caixa: " + error.message, "Erro de Dados");
                });
            }
            // Load Cashflow Transactions separately because the main cashflow document doesn't store the full list of transactions to avoid document size limits
            const cashflowTransactionsColRef = getCollectionRef('cashflowTransactions');
            if (cashflowTransactionsColRef) {
                onSnapshot(query(cashflowTransactionsColRef, orderBy('timestamp', 'desc')), (snapshot) => {
                    data.cashflow.transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    // Manually update cashflow balance from transactions
                    let calculatedBalance = 0;
                    let revenues = [];
                    let expenses = [];
                    let labels = [];
                    
                    // Simple aggregation for chart (last 7 days conceptual)
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(today.getDate() - i);
                        labels.push(date.toLocaleDateString('pt-BR', { month: 'short', day: 'numeric' }));
                        revenues.push(0);
                        expenses.push(0);
                    }

                    data.cashflow.transactions.forEach(t => {
                        const transactionDate = new Date(t.date);
                        transactionDate.setHours(0, 0, 0, 0);

                        // Update current balance
                        if (t.type === 'revenue') {
                            calculatedBalance += t.value;
                        } else {
                            calculatedBalance -= t.value;
                        }
                        
                        // Update chart data for the last 7 days
                        const diffTime = Math.abs(today.getTime() - transactionDate.getTime());
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (diffDays >= 0 && diffDays < 7) {
                            const index = 6 - diffDays;
                            if (t.type === 'revenue') {
                                revenues[index] += t.value;
                            } else {
                                expenses[index] += t.value;
                            }
                        }
                    });
                    data.cashflow.balance = calculatedBalance; // Update main balance
                    data.cashflow.chartData = { labels, revenues, expenses };

                    if (!document.getElementById('financial').classList.contains('hidden') && data.settings.modules.cashflow) {
                        renderCashflow();
                    }
                }, (error) => {
                    console.error("Erro ao carregar transações de caixa:", error);
                    showAlert("Erro ao carregar transações de caixa: " + error.message, "Erro de Dados");
                });
            }

            // Load Daily Cash
            const dailyCashDocRef = doc(getUserDocRef(), 'dailyCash');
            if (dailyCashDocRef) {
                onSnapshot(dailyCashDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        Object.assign(data.dailyCash, docSnap.data());
                        data.dailyCash.movements = data.dailyCash.movements || []; // Ensure movements array exists
                        if (!document.getElementById('financial').classList.contains('hidden') && data.settings.modules.cashflow) {
                            renderDailyCash();
                        }
                    } else {
                        setDoc(dailyCashDocRef, { isOpen: false, openingBalance: 0, currentBalance: 0, totalIn: 0, totalOut: 0, movements: [] }); // Initialize
                    }
                }, (error) => {
                    console.error("Erro ao carregar caixa diário:", error);
                    showAlert("Erro ao carregar caixa diário: " + error.message, "Erro de Dados");
                });
            }

            // Load Message Templates
            const messageTemplatesColRef = getCollectionRef('messageTemplates');
            if (messageTemplatesColRef) {
                onSnapshot(messageTemplatesColRef, (snapshot) => {
                    data.messageTemplates = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    if (!document.getElementById('communication').classList.contains('hidden')) {
                        renderCommunicationSettings();
                    }
                }, (error) => {
                    console.error("Erro ao carregar templates de mensagem:", error);
                    showAlert("Erro ao carregar templates de mensagem: " + error.message, "Erro de Dados");
                });
            }
        }


        function showSection(sectionId) {
            contentSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(sectionId).classList.remove('hidden');
            mainTitle.textContent = document.querySelector(`.sidebar-link[data-section="${sectionId}"]`).textContent.split(' ')[1].trim(); /* Remove icon and space */

            sidebarLinks.forEach(link => link.classList.remove('active'));
            document.querySelector(`.sidebar-link[data-section="${sectionId}"]`).classList.add('active');

            // Specific module rendering based on sectionId
            if (sectionId === 'dashboard') {
                renderSalesChart();
                updateDashboardMetrics();
            } else if (sectionId === 'menu') {
                renderMenuItems();
            } else if (sectionId === 'orders') {
                renderOrders();
                ordersTabList.classList.add('active');
                ordersTabKds.classList.remove('active');
                ordersListView.classList.remove('hidden');
                ordersKdsView.classList.add('hidden');
            } else if (sectionId === 'coupons') {
                renderCoupons();
            } else if (sectionId === 'settings') {
                renderSettings();
            } else if (sectionId === 'financial') {
                renderFinancial();
            } else if (sectionId === 'faq') {
                renderFaq();
            } else if (sectionId === 'reviews') {
                renderReviews();
            } else if (sectionId === 'sales-growth') {
                renderSalesGrowthTips();
            } else if (sectionId === 'packaging') {
                renderPackaging();
            } else if (sectionId === 'budget') {
                renderBudgetRequests();
            } else if (sectionId === 'social-media') {
                renderSocialMediaSettings();
            } else if (sectionId === 'shipping') {
                renderShippingSettings();
            } else if (sectionId === 'ia-whatsapp-management') {
                renderIaWhatsappManagement();
            } else if (sectionId === 'tracking') {
                // Tracking is mostly static for now, just show the section
            } else if (sectionId === 'communication') {
                renderCommunicationSettings();
            }
        }

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                const sectionId = e.target.dataset.section;
                showSection(sectionId);
            });
        });

        // Dashboard Metrics Update
        function updateDashboardMetrics() {
            const activeOrders = data.orders.filter(order => order.status !== 'Entregue' && order.status !== 'Cancelado');
            const newOrders = activeOrders.filter(order => !order.confirmationTime);
            document.getElementById('dashboard-active-orders').textContent = activeOrders.length;
            document.getElementById('dashboard-new-orders-count').textContent = newOrders.length;

            const totalSales = data.orders.filter(o => o.status === 'Entregue')
                                        .reduce((sum, order) => sum + order.total, 0);
            document.getElementById('dashboard-sales-today').textContent = totalSales.toFixed(2);
            document.getElementById('dashboard-avg-ticket').textContent = totalSales > 0 && data.orders.length > 0
                                                                            ? (totalSales / data.orders.filter(o => o.status === 'Entregue').length).toFixed(2)
                                                                            : '0.00';

            const totalRating = data.reviews.reduce((sum, review) => sum + review.rating, 0);
            const avgRating = data.reviews.length > 0 ? (totalRating / data.reviews.length).toFixed(1) : '0.0';
            document.getElementById('dashboard-avg-rating').textContent = avgRating;
            document.getElementById('dashboard-total-reviews').textContent = data.reviews.length;

            updateNewOrdersCount(); // Also update the badge count
        }


        // Dashboard Chart
        function renderSalesChart() {
            if (salesChart) {
                salesChart.destroy();
            }
            const labels = ['Dia -6', 'Dia -5', 'Dia -4', 'Dia -3', 'Dia -2', 'Ontem', 'Hoje'];
            const salesData = [800, 950, 1100, 1050, 1300, 1200, 1250]; /* Dados simulados */

            salesChart = new Chart(salesChartCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: salesData,
                        backgroundColor: 'rgba(79, 70, 229, 0.6)', /* indigo-600 with transparency */
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Valor (R$)' }
                        },
                        x: {
                            title: { display: true, text: 'Dia' }
                        }
                    }
                }
            });
        }

        // Menu Management
        itemCategorySelect.addEventListener('change', (e) => {
            if (e.target.value === 'Pizzas') {
                pizzaFlavorsInputGroup.classList.remove('hidden');
            } else {
                pizzaFlavorsInputGroup.classList.add('hidden');
            }
        });

        generateDescriptionBtn.addEventListener('click', async () => {
            const itemName = document.getElementById('item-name').value;
            const itemDescriptionElem = document.getElementById('item-description');
            if (!itemName) {
                await showAlert('Por favor, insira o nome do item para gerar a descrição.');
                return;
            }

            itemDescriptionElem.value = 'Gerando descrição com IA...';
            itemDescriptionElem.disabled = true;
            generateDescriptionBtn.disabled = true;

            try {
                const prompt = `Gerar uma descrição curta e atraente para um item de restaurante. Nome: "${itemName}". Categoria: "${document.getElementById('item-category').value}". Focar em sabor e experiência. Limite de 100 caracteres.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    itemDescriptionElem.value = result.candidates[0].content.parts[0].text;
                } else {
                    itemDescriptionElem.value = 'Não foi possível gerar a descrição. Tente novamente.';
                }
            } catch (error) {
                console.error('Erro ao chamar a API Gemini:', error);
                itemDescriptionElem.value = 'Erro ao gerar descrição: ' + error.message;
            } finally {
                itemDescriptionElem.disabled = false;
                generateDescriptionBtn.disabled = false;
            }
        });


        function renderMenuItems() {
            menuItemsList.innerHTML = '';
            data.menuItems.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'bg-slate-50 p-4 rounded-lg flex items-center space-x-4 border border-slate-200';
                let priceHtml = `<p class="text-slate-700">R$ ${item.price.toFixed(2)}</p>`;
                if (item.promo && item.promoPrice !== null) {
                    priceHtml = `
                        <p class="text-slate-500 line-through">R$ ${item.price.toFixed(2)}</p>
                        <p class="font-semibold text-red-600">R$ ${item.promoPrice.toFixed(2)}</p>
                    `;
                }
                let flavorsHtml = '';
                if (item.flavors) {
                    flavorsHtml = `<p class="text-slate-500 text-xs mt-1">Sabores: ${item.flavors}</p>`;
                }

                itemDiv.innerHTML = `
                    <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md">
                    <div class="flex-grow">
                        <p class="font-semibold text-slate-800">${item.name} <span class="text-xs text-slate-500">(${item.category})</span></p>
                        ${priceHtml}
                        <p class="text-slate-600 text-sm">${item.description && item.description.length > 50 ? item.description.substring(0, 50) + '...' : item.description || ''}</p>
                        ${flavorsHtml}
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <div class="flex items-center space-x-2">
                            <span class="order-status-badge ${item.promo ? 'bg-orange-100 text-orange-600' : 'hidden'}">Promoção</span>
                            <span class="order-status-badge ${item.active ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${item.active ? 'Ativo' : 'Em Falta'}</span>
                        </div>
                        <div class="flex space-x-2">
                            <button class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm" data-id="${item.id}" onclick="openEditModal('${item.id}')">Editar</button>
                            <button class="text-red-600 hover:text-red-800 font-semibold text-sm" data-id="${item.id}" onclick="deleteMenuItem('${item.id}')">Excluir</button>
                        </div>
                    </div>
                `;
                menuItemsList.appendChild(itemDiv);
            });
        }

        addMenuItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const promoChecked = document.getElementById('item-promo-toggle').checked;
            const category = document.getElementById('item-category').value;
            const newItem = {
                name: document.getElementById('item-name').value,
                price: parseFloat(document.getElementById('item-price').value),
                promoPrice: promoChecked ? parseFloat(document.getElementById('item-promo-price').value) : null,
                description: document.getElementById('item-description').value,
                category: category,
                image: document.getElementById('item-image').value,
                promo: promoChecked,
                active: document.getElementById('item-active').checked,
                flavors: (category === 'Pizzas' && !pizzaFlavorsInputGroup.classList.contains('hidden')) ? document.getElementById('item-flavors').value : null,
                createdAt: serverTimestamp() // Add timestamp
            };
            try {
                await addDoc(getCollectionRef('menuItems'), newItem);
                await showAlert('Item adicionado com sucesso!', 'Sucesso');
                addMenuItemForm.reset();
                pizzaFlavorsInputGroup.classList.add('hidden'); /* Reset hidden state */
            } catch (error) {
                console.error("Erro ao adicionar item:", error);
                await showAlert("Erro ao adicionar item: " + error.message, "Erro");
            }
        });

        editItemCategorySelect.addEventListener('change', (e) => {
            if (e.target.value === 'Pizzas') {
                editPizzaFlavorsInputGroup.classList.remove('hidden');
            } else {
                editPizzaFlavorsInputGroup.classList.add('hidden');
            }
        });

        function openEditModal(id) {
            const item = data.menuItems.find(i => i.id === id);
            if (item) {
                document.getElementById('edit-item-id').value = item.id;
                document.getElementById('edit-item-name').value = item.name;
                document.getElementById('edit-item-price').value = item.price;
                document.getElementById('edit-item-promo-price').value = item.promoPrice || '';
                document.getElementById('edit-item-description').value = item.description;
                document.getElementById('edit-item-category').value = item.category;
                document.getElementById('edit-item-image').value = item.image;
                document.getElementById('edit-item-active').checked = item.active;
                document.getElementById('edit-item-promo-toggle').checked = item.promo;
                
                if (item.category === 'Pizzas') {
                    editPizzaFlavorsInputGroup.classList.remove('hidden');
                    document.getElementById('edit-item-flavors').value = item.flavors || '';
                } else {
                    editPizzaFlavorsInputGroup.classList.add('hidden');
                    document.getElementById('edit-item-flavors').value = '';
                }

                editItemModal.classList.remove('hidden');
            }
        }

        function closeEditModal() {
            editItemModal.classList.add('hidden');
        }

        editItemForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-item-id').value;
            const itemIndex = data.menuItems.findIndex(i => i.id === id);
            if (itemIndex !== -1) {
                const promoChecked = document.getElementById('edit-item-promo-toggle').checked;
                const category = document.getElementById('edit-item-category').value;
                const updatedItem = {
                    name: document.getElementById('edit-item-name').value,
                    price: parseFloat(document.getElementById('edit-item-price').value),
                    promoPrice: promoChecked ? parseFloat(document.getElementById('edit-item-promo-price').value) : null,
                    description: document.getElementById('edit-item-description').value,
                    category: category,
                    image: document.getElementById('edit-item-image').value,
                    promo: promoChecked,
                    active: document.getElementById('edit-item-active').checked,
                    flavors: (category === 'Pizzas' && !editPizzaFlavorsInputGroup.classList.contains('hidden')) ? document.getElementById('edit-item-flavors').value : null
                };
                try {
                    await updateDoc(getDocRef('menuItems', id), updatedItem);
                    await showAlert('Item atualizado com sucesso!', 'Sucesso');
                    closeEditModal();
                } catch (error) {
                    console.error("Erro ao atualizar item:", error);
                    await showAlert("Erro ao atualizar item: " + error.message, "Erro");
                }
            }
        });

        async function deleteMenuItem(id) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o item ${id}?`);
            if (confirmed) {
                try {
                    await deleteDoc(getDocRef('menuItems', id));
                    await showAlert('Item excluído com sucesso!', 'Sucesso');
                } catch (error) {
                    console.error("Erro ao excluir item:", error);
                    await showAlert("Erro ao excluir item: " + error.message, "Erro");
                }
            }
        }

        // Order Management
        let orderTimers = {};
        let notificationTimeout;

        function showToastNotification(message, type = 'info', eventId = null) {
            if (!data.settings.notificationsActive) {
                return; // Notificações desativadas nas configurações
            }
            if (eventId && data.notifiedEvents.has(eventId)) {
                return; // Não mostra se já foi ignorado/fechado
            }

            const toast = document.createElement('div');
            toast.className = `toast-notification ${type === 'error' ? 'bg-red-600' : 'bg-indigo-600'} show`;
            
            const messageText = document.createElement('span');
            messageText.textContent = message;
            toast.appendChild(messageText);

            const closeButton = document.createElement('button');
            closeButton.className = 'ml-4 p-1 rounded-full hover:bg-white hover:bg-opacity-20 transition';
            closeButton.innerHTML = '&times;'; // Caractere 'x' para fechar
            closeButton.onclick = () => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
                if (notificationTimeout) { // Limpa o timeout se o usuário fechar manualmente
                    clearTimeout(notificationTimeout);
                }
                if (eventId) {
                    data.notifiedEvents.add(eventId); // Marca como ignorado
                }
            };
            toast.appendChild(closeButton);

            document.body.appendChild(toast);

            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            notificationTimeout = setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
                if (eventId) {
                    data.notifiedEvents.add(eventId); // Marca como ignorado
                }
            }, 5000);
        }

        function updateNewOrdersCount() {
            const newOrders = data.orders.filter(order => order.status === 'Confirmado' && !order.confirmationTime);
            newOrdersCount.textContent = newOrders.length > 0 ? newOrders.length : '';
            if (newOrders.length > 0) {
                newOrdersCount.classList.remove('hidden');
            } else {
                newOrdersCount.classList.add('hidden');
            }
        }

        function startOrderTimer(orderId, startTime) {
            const timerElement = document.getElementById(`timer-${orderId}`);
            if (!timerElement) return;

            const updateTimer = () => {
                const now = new Date().getTime();
                const elapsed = Math.floor((now - startTime) / 1000);
                const remaining = 240 - elapsed; /* 4 minutos = 240 segundos */

                if (remaining <= 0) {
                    timerElement.textContent = 'Cancelando...';
                    updateOrderStatus(orderId, 'Cancelado'); /* Auto-cancelar */
                    showToastNotification(`Pedido #${orderId} foi automaticamente cancelado por falta de confirmação.`, 'error', `order-auto-cancel-${orderId}`);
                    clearInterval(orderTimers[orderId]);
                    delete orderTimers[orderId]; // Clean up timer
                } else {
                    const minutes = Math.floor(remaining / 60);
                    const seconds = remaining % 60;
                    timerElement.textContent = `Confirme em: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            };
            
            // Clear existing timer for this order before setting a new one
            if (orderTimers[orderId]) {
                clearInterval(orderTimers[orderId]);
            }
            orderTimers[orderId] = setInterval(updateTimer, 1000);
            updateTimer(); /* Chamar imediatamente para evitar atraso de 1s */
        }

        function renderOrders() {
            activeOrdersList.innerHTML = '';
            orderHistoryList.innerHTML = '';
            kdsOrdersGrid.innerHTML = ''; /* Clear KDS view */

            // Clear all active timers before re-rendering
            Object.values(orderTimers).forEach(clearInterval);
            orderTimers = {};

            const activeOrders = data.orders.filter(order => order.status !== 'Entregue' && order.status !== 'Cancelado');
            const historyOrders = data.orders.filter(order => order.status === 'Entregue' || order.status === 'Cancelado');
            const kdsOrders = data.orders.filter(order => order.kdsStatus !== 'Concluído' && order.status !== 'Cancelado');

            if (activeOrders.length === 0) {
                activeOrdersList.innerHTML = '<p class="text-slate-500">Nenhum pedido ativo no momento.</p>';
            } else {
                activeOrders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200';
                    let timerHtml = '';
                    if (order.status === 'Confirmado' && !order.confirmationTime) {
                        const orderTimestamp = new Date(order.timestamp.toDate()).getTime(); // Convert Firestore Timestamp to Date
                        timerHtml = `<p id="timer-${order.id}" class="text-red-500 font-semibold text-sm mt-1">Confirme em: --:--</p>`;
                        // Start timer only if it's a new unconfirmed order
                        if (!orderTimers[order.id]) {
                            setTimeout(() => startOrderTimer(order.id, orderTimestamp), 0);
                        }
                    }
                    let scheduledDeliveryHtml = '';
                    if (order.scheduledTime && data.settings.modules.scheduledDelivery) {
                        const date = order.scheduledTime.toDate ? order.scheduledTime.toDate() : new Date(order.scheduledTime);
                        scheduledDeliveryHtml = `<p class="text-indigo-600 text-xs font-semibold mt-1">Agendado para: ${date.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit'})}</p>`;
                    }

                    orderDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-bold text-slate-900">Pedido #${order.id}</p>
                            <span class="order-status-badge status-${order.status.replace(/\s/g, '-') /* Replace spaces for Tailwind class */ }">${order.status}</span>
                        </div>
                        <p class="text-slate-700">Cliente: ${order.customer}</p>
                        <p class="text-slate-700">Total: R$ ${order.total.toFixed(2)}</p>
                        ${timerHtml}
                        ${scheduledDeliveryHtml}
                        <p class="text-slate-500 text-xs">Horário: ${new Date(order.timestamp.toDate()).toLocaleString('pt-BR')}</p>
                        <button class="text-indigo-600 hover:text-indigo-800 text-sm mt-2" onclick="toggleOrderDetails('${order.id}')">Ver Detalhes</button>
                        <div id="order-details-${order.id}" class="hidden mt-2 p-2 bg-slate-100 rounded">
                            <h4 class="font-semibold text-slate-800 mb-1">Itens do Pedido:</h4>
                            <ul class="list-disc list-inside text-slate-700 text-sm">
                                ${order.items.map(item => `<li>${item.qty}x ${item.name}</li>`).join('')}
                            </ul>
                            <p class="text-slate-700 text-sm mt-2">Endereço: Rua Exemplo, 123 - Bairro Teste</p>
                            <p class="text-slate-700 text-sm">Método de Pagamento: Cartão Online</p>
                            <p class="text-slate-700 text-sm mt-1">Nota Fiscal: Sim</p>
                            <p class="text-slate-700 text-sm">Observações do Cliente: Sem cebola, por favor.</p>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-full transition ${data.settings.modules.printCommand ? '' : 'hidden'}" onclick="printOrderCommand('${order.id}')">Imprimir Comanda</button>
                                <button class="bg-gray-500 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="openChatModal('${order.customer}', '${order.id}')">Chat com Cliente</button>
                            </div>
                        </div>
                        <div class="mt-3 flex flex-wrap gap-2">
                            <button class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateOrderStatus('${order.id}', 'Em Preparo')">Em Preparo</button>
                            <button class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateOrderStatus('${order.id}', 'Saiu para Entrega')">Saiu para Entrega</button>
                            <button class="bg-green-500 hover:bg-green-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateOrderStatus('${order.id}', 'Entregue')">Entregue</button>
                            <button class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="cancelOrder('${order.id}')">Cancelar</button>
                        </div>
                    `;
                    activeOrdersList.appendChild(orderDiv);
                });
            }

            if (historyOrders.length === 0) {
                orderHistoryList.innerHTML = '<p class="text-slate-500">Nenhum pedido no histórico.</p>';
            } else {
                historyOrders.forEach(order => {
                    const orderDiv = document.createElement('div');
                    orderDiv.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200';
                    let scheduledDeliveryHtml = '';
                    if (order.scheduledTime && data.settings.modules.scheduledDelivery) {
                        const date = order.scheduledTime.toDate ? order.scheduledTime.toDate() : new Date(order.scheduledTime);
                        scheduledDeliveryHtml = `<p class="text-indigo-600 text-xs font-semibold mt-1">Agendado para: ${date.toLocaleString('pt-BR', { hour: '2-digit', minute: '2-digit', day: '2-digit', month: '2-digit'})}</p>`;
                    }
                    orderDiv.innerHTML = `
                        <div class="flex justify-between items-center mb-2">
                            <p class="font-bold text-slate-900">Pedido #${order.id}</p>
                            <span class="order-status-badge status-${order.status.replace(/\s/g, '-') /* Replace spaces for Tailwind class */}">${order.status}</span>
                        </div>
                        <p class="text-slate-700">Cliente: ${order.customer}</p>
                        <p class="text-slate-700">Total: R$ ${order.total.toFixed(2)}</p>
                        ${scheduledDeliveryHtml}
                        <p class="text-slate-500 text-xs">Horário: ${new Date(order.timestamp.toDate()).toLocaleString('pt-BR')}</p>
                        <button class="text-indigo-600 hover:text-indigo-800 text-sm mt-2" onclick="toggleOrderDetails('${order.id}')">Ver Detalhes</button>
                        <div id="order-details-${order.id}" class="hidden mt-2 p-2 bg-slate-100 rounded">
                            <h4 class="font-semibold text-slate-800 mb-1">Itens do Pedido:</h4>
                            <ul class="list-disc list-inside text-slate-700 text-sm">
                                ${order.items.map(item => `<li>${item.qty}x ${item.name}</li>`).join('')}
                            </ul>
                            <p class="text-slate-700 text-sm mt-2">Endereço: Rua Exemplo, 123 - Bairro Teste</p>
                            <p class="text-slate-700 text-sm">Método de Pagamento: Cartão Online</p>
                            <p class="text-slate-700 text-sm mt-1">Nota Fiscal: Sim</p>
                            <p class="text-slate-700 text-sm">Observações do Cliente: Sem cebola, por favor.</p>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded-full transition ${data.settings.modules.printCommand ? '' : 'hidden'}" onclick="printOrderCommand('${order.id}')">Imprimir Comanda</button>
                                <button class="bg-gray-500 hover:bg-gray-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="openChatModal('${order.customer}', '${order.id}')">Chat com Cliente</button>
                            </div>
                        </div>
                    `;
                    orderHistoryList.appendChild(orderDiv);
                });
            }
            updateNewOrdersCount();

            // Render KDS orders
            kdsOrders.forEach(order => {
                const kdsCard = document.createElement('div');
                kdsCard.className = `kds-order-card ${order.kdsStatus === 'Preparando' ? 'preparing' : ''} ${order.kdsStatus === 'Pronto' ? 'ready' : ''}`;
                kdsCard.innerHTML = `
                    <p class="font-bold text-lg text-slate-900">Pedido #${order.id}</p>
                    <p class="text-slate-600 text-sm mb-2">Cliente: ${order.customer}</p>
                    <ul class="list-disc list-inside text-slate-700 text-sm mb-3">
                        ${order.items.map(item => `<li>${item.qty}x ${item.name}</li>`).join('')}
                    </ul>
                    <p class="text-slate-500 text-xs">Status: ${order.kdsStatus}</p>
                    <div class="mt-3">
                        ${order.kdsStatus === 'Pendente' ? `<button class="bg-yellow-500 hover:bg-yellow-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateKdsStatus('${order.id}', 'Preparando')">Iniciar Preparo</button>` : ''}
                        ${order.kdsStatus === 'Preparando' ? `<button class="bg-green-500 hover:bg-green-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateKdsStatus('${order.id}', 'Pronto')">Marcar Pronto</button>` : ''}
                    </div>
                `;
                kdsOrdersGrid.appendChild(kdsCard);
            });
        }

        ordersTabList.addEventListener('click', () => {
            ordersTabList.classList.add('active');
            ordersTabKds.classList.remove('active');
            ordersListView.classList.remove('hidden');
            ordersKdsView.classList.add('hidden');
            renderOrders(); // Re-render to ensure list view is updated
        });

        ordersTabKds.addEventListener('click', () => {
            ordersTabKds.classList.add('active');
            ordersTabList.classList.remove('active');
            ordersListView.classList.add('hidden');
            ordersKdsView.classList.remove('hidden');
            renderOrders(); // Re-render to ensure KDS view is updated
        });

        async function updateKdsStatus(orderId, newStatus) {
            const orderRef = getDocRef('orders', orderId);
            if (orderRef) {
                try {
                    await updateDoc(orderRef, { kdsStatus: newStatus });
                    if (newStatus === 'Pronto') {
                        await showToastNotification(`Pedido #${orderId} está pronto para entrega!`);
                    }
                } catch (error) {
                    console.error("Erro ao atualizar status KDS:", error);
                    await showAlert("Erro ao atualizar status KDS: " + error.message, "Erro");
                }
            }
        }

        function toggleOrderDetails(orderId) {
            const detailsDiv = document.getElementById(`order-details-${orderId}`);
            if (detailsDiv) {
                detailsDiv.classList.toggle('hidden');
            }
        }

        async function updateOrderStatus(orderId, newStatus) {
            const orderRef = getDocRef('orders', orderId);
            if (orderRef) {
                try {
                    const updateData = { status: newStatus };
                    if (newStatus === 'Confirmado' && !data.orders.find(o => o.id === orderId)?.confirmationTime) {
                        updateData.confirmationTime = serverTimestamp();
                        clearInterval(orderTimers[orderId]);
                        delete orderTimers[orderId];
                    }
                    await updateDoc(orderRef, updateData);
                    await showAlert(`Pedido #${orderId} atualizado para: ${newStatus}`, 'Sucesso');
                } catch (error) {
                    console.error("Erro ao atualizar status do pedido:", error);
                    await showAlert("Erro ao atualizar status do pedido: " + error.message, "Erro");
                }
            }
        }

        async function cancelOrder(orderId) {
            const confirmed = await showConfirm(`Tem certeza que deseja cancelar o pedido ${orderId}?`);
            if (confirmed) {
                const orderRef = getDocRef('orders', orderId);
                if (orderRef) {
                    try {
                        await updateDoc(orderRef, { status: 'Cancelado', kdsStatus: 'Concluído', confirmationTime: serverTimestamp() });
                        clearInterval(orderTimers[orderId]);
                        delete orderTimers[orderId];
                        showToastNotification(`Pedido #${orderId} foi cancelado.`, 'error', `order-manual-cancel-${orderId}`);
                    } catch (error) {
                        console.error("Erro ao cancelar pedido:", error);
                        await showAlert("Erro ao cancelar pedido: " + error.message, "Erro");
                    }
                }
            }
        }

        async function printOrderCommand(orderId) {
            await showAlert(`Comanda do Pedido #${orderId} simulando impressão.`, 'Impressão');
            // Em uma aplicação real, aqui haveria uma chamada para a API de impressão ou geração de PDF
        }

        function openChatModal(clientName, orderId) {
            currentChatOrderId = orderId;
            const order = data.orders.find(o => o.id === orderId);
            if (!order) return;

            chatModal.classList.remove('hidden');
            chatClientName.textContent = clientName;
            chatOrderId.textContent = orderId;
            renderChatMessages(order.chatHistory);
        }

        function closeChatModal() {
            chatModal.classList.add('hidden');
            currentChatOrderId = null;
            chatMessagesContent.innerHTML = ''; // Clear chat history
            // Re-add the generate button in its original state
            aiSuggestionsContainer.innerHTML = `<button type="button" id="generate-chat-suggestion-btn" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-800 text-sm py-2 px-3 rounded-lg transition">Gerar Sugestões de Resposta ✨</button>`;
            document.getElementById('chat-input-text').value = '';
            document.getElementById('generate-chat-suggestion-btn').addEventListener('click', () => generateChatResponseSuggestion(currentChatOrderId));
        }

        function renderChatMessages(messages) {
            chatMessagesContent.innerHTML = '';
            messages.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = `max-w-[80%] p-2 rounded-lg ${msg.sender === 'restaurant' ? 'bg-indigo-100 self-end ml-auto' : 'bg-gray-100 self-start mr-auto'}`;
                msgDiv.textContent = msg.text;
                chatMessagesContent.appendChild(msgDiv);
            });
            chatMessagesContent.scrollTop = chatMessagesContent.scrollHeight;
        }

        async function sendMessage() {
            const text = chatInputText.value.trim();
            if (!text || !currentChatOrderId) return;

            const order = data.orders.find(o => o.id === currentChatOrderId);
            if (order) {
                const orderRef = getDocRef('orders', currentChatOrderId);
                const updatedChatHistory = [...order.chatHistory, { sender: 'restaurant', text: text, timestamp: serverTimestamp() }];
                try {
                    await updateDoc(orderRef, { chatHistory: updatedChatHistory });
                    chatInputText.value = '';
                    // Simulate client response (can be replaced by real AI response later)
                    setTimeout(async () => {
                        const simulatedClientResponse = `Recebido! Obrigado.`;
                        const finalChatHistory = [...updatedChatHistory, { sender: 'client', text: simulatedClientResponse, timestamp: serverTimestamp() }];
                        await updateDoc(orderRef, { chatHistory: finalChatHistory });
                    }, 1500);
                } catch (error) {
                    console.error("Erro ao enviar mensagem:", error);
                    await showAlert("Erro ao enviar mensagem: " + error.message, "Erro");
                }
            }
        }

        document.getElementById('generate-chat-suggestion-btn').addEventListener('click', async () => {
            if (!currentChatOrderId) return;

            const order = data.orders.find(o => o.id === currentChatOrderId);
            if (!order) return;

            const originalButtonText = generateChatSuggestionBtn.textContent;
            generateChatSuggestionBtn.textContent = 'Gerando...';
            generateChatSuggestionBtn.disabled = true;
            aiSuggestionsContainer.querySelectorAll('.ai-suggestion').forEach(el => el.remove());

            try {
                const lastClientMessage = order.chatHistory.filter(msg => msg.sender === 'client').pop();
                const prompt = `Gerar 3 sugestões de respostas curtas e profissionais para o chat de um cliente de delivery. O cliente perguntou: "${lastClientMessage ? lastClientMessage.text : 'Qual é o status do meu pedido?'}". O pedido é #${order.id} e o status é "${order.status}". O cliente é ${order.customer}. Limite cada sugestão a 15 palavras. Separe as sugestões por ponto e vírgula.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const suggestions = result.candidates[0].content.parts[0].text.split(';').map(s => s.trim()).filter(s => s.length > 0);
                    suggestions.forEach(sug => {
                        const sugBtn = document.createElement('div');
                        sugBtn.className = 'ai-suggestion';
                        sugBtn.textContent = sug;
                        sugBtn.onclick = () => {
                            chatInputText.value = sug;
                            aiSuggestionsContainer.querySelectorAll('.ai-suggestion').forEach(el => el.remove());
                        };
                        aiSuggestionsContainer.appendChild(sugBtn);
                    });
                } else {
                    const noSuggestion = document.createElement('div');
                    noSuggestion.className = 'ai-suggestion';
                    noSuggestion.textContent = 'Nenhuma sugestão disponível no momento.';
                    aiSuggestionsContainer.appendChild(noSuggestion);
                }
            } catch (error) {
                console.error('Erro ao gerar sugestões de chat:', error);
                const errorSug = document.createElement('div');
                errorSug.className = 'ai-suggestion';
                errorSug.textContent = 'Erro ao gerar sugestões.';
                aiSuggestionsContainer.appendChild(errorSug);
            } finally {
                generateChatSuggestionBtn.textContent = originalButtonText;
                generateChatSuggestionBtn.disabled = false;
            }
        });

        // Coupon Management
        function renderCoupons() {
            couponList.innerHTML = '';
            data.coupons.forEach(coupon => {
                const couponDiv = document.createElement('div');
                couponDiv.className = 'bg-slate-50 p-4 rounded-lg flex justify-between items-center border border-slate-200';
                couponDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${coupon.code} <span class="text-xs text-slate-500">(${coupon.type === 'percentage' ? coupon.value + '%' : 'R$' + coupon.value.toFixed(2)})</span></p>
                        <p class="text-slate-600 text-sm">Validade: ${coupon.expiry}</p>
                        <p class="text-slate-600 text-sm">Mínimo: R$ ${coupon.minOrder.toFixed(2)}</p>
                        <p class="text-slate-600 text-sm">Usos: ${coupon.usageLimit === 0 ? 'Ilimitado' : coupon.usageLimit}</p>
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <span class="order-status-badge ${coupon.active ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${coupon.active ? 'Ativo' : 'Inativo'}</span>
                        <div class="flex space-x-2">
                            <button class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm" onclick="editCoupon('${coupon.id}')">Editar</button>
                            <button class="text-red-600 hover:text-red-800 font-semibold text-sm" onclick="deleteCoupon('${coupon.id}')">Excluir</button>
                        </div>
                    </div>
                `;
                couponList.appendChild(couponDiv);
            });
        }

        addCouponForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newCoupon = {
                code: document.getElementById('coupon-code').value.toUpperCase(),
                type: document.getElementById('coupon-type').value,
                value: parseFloat(document.getElementById('coupon-value').value),
                expiry: document.getElementById('coupon-expiry').value,
                minOrder: parseFloat(document.getElementById('coupon-min-order').value),
                usageLimit: parseInt(document.getElementById('coupon-usage-limit').value),
                active: document.getElementById('coupon-active').checked,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(getCollectionRef('coupons'), newCoupon);
                await showAlert('Cupom adicionado com sucesso!', 'Sucesso');
                addCouponForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar cupom:", error);
                await showAlert("Erro ao adicionar cupom: " + error.message, "Erro");
            }
        });

        async function editCoupon(id) {
            await showAlert(`Funcionalidade de edição para o cupom ${id} será implementada.`, 'Aviso');
            // Implementação real exigiria um modal de edição similar ao de menuItems
        }

        async function deleteCoupon(id) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir o cupom ${id}?`);
            if (confirmed) {
                try {
                    await deleteDoc(getDocRef('coupons', id));
                    await showAlert('Cupom excluído com sucesso!', 'Sucesso');
                } catch (error) {
                    console.error("Erro ao excluir cupom:", error);
                    await showAlert("Erro ao excluir cupom: " + error.message, "Erro");
                }
            }
        }

        // Store Settings
        function updateModuleVisibility() {
            sidebarPackagingLinkContainer.classList.toggle('hidden', !data.settings.modules.packaging);
            sidebarBudgetLinkContainer.classList.toggle('hidden', !data.settings.modules.budget);
            sidebarSocialMediaLinkContainer.classList.toggle('hidden', !data.settings.modules.socialMedia);
            sidebarShippingLinkContainer.classList.toggle('hidden', !data.settings.modules.shippingRates);
            sidebarIaWhatsappMgmtLinkContainer.classList.toggle('hidden', !data.settings.modules.iaWhatsappMgmt);
            sidebarTrackingLinkContainer.classList.toggle('hidden', !data.settings.modules.tracking);
            sidebarCommunicationLinkContainer.classList.toggle('hidden', !data.settings.modules.communication);
            cashflowModuleContainer.classList.toggle('hidden', !data.settings.modules.cashflow);
            dailyCashModuleContainer.classList.toggle('hidden', !data.settings.modules.cashflow); 
        }

        function renderSettings() {
            document.getElementById('delivery-time').value = data.settings.deliveryTime || 40;
            document.getElementById('min-order-value-setting').value = data.settings.minOrderValue || 25.00;

            renderOperatingHours();
            renderPaymentMethods();

            storeStatusRadios.forEach(radio => {
                // Attach event listener only once
                if (!radio.dataset.listenerAttached) {
                    radio.addEventListener('change', async () => {
                        if (radio.value === 'schedule-close') {
                            scheduleCloseOptions.classList.remove('hidden');
                        } else {
                            scheduleCloseOptions.classList.add('hidden');
                        }
                        const newStatus = radio.value;
                        try {
                            await updateDoc(getUserDocRef(), { 'settings.storeStatus': newStatus });
                            await showAlert(`Status da loja atualizado para: ${newStatus}`, 'Sucesso');
                        } catch (error) {
                            console.error("Erro ao atualizar status da loja:", error);
                            await showAlert("Erro ao atualizar status da loja: " + error.message, "Erro");
                        }
                    });
                    radio.dataset.listenerAttached = 'true';
                }
                if (data.settings.storeStatus === radio.value) {
                    radio.checked = true;
                    if (radio.value === 'schedule-close') {
                        scheduleCloseOptions.classList.remove('hidden');
                    } else {
                        scheduleCloseOptions.classList.add('hidden');
                    }
                }
            });
            // Initial state for scheduled close options
            if (data.settings.storeStatus === 'schedule-close') {
                document.getElementById('schedule-start-date').value = data.settings.scheduleStartDate || '';
                document.getElementById('schedule-end-date').value = data.settings.scheduleEndDate || '';
            }


            // Attach event listener only once for pause button
            if (!pauseNowButton.dataset.listenerAttached) {
                pauseNowButton.addEventListener('click', async () => {
                    const confirmed = await showConfirm('Tem certeza que deseja pausar a loja temporariamente?', 'Pausar Loja');
                    if (confirmed) {
                        try {
                            await updateDoc(getUserDocRef(), { 'settings.storeStatus': 'closed' });
                            document.querySelector('input[name="store-status"][value="closed"]').checked = true;
                            scheduleCloseOptions.classList.add('hidden'); // Hide schedule options if pausing now
                            await showAlert('Loja pausada temporariamente.', 'Sucesso');
                        } catch (error) {
                            console.error("Erro ao pausar loja:", error);
                            await showAlert("Erro ao pausar loja: " + error.message, "Erro");
                        }
                    }
                });
                pauseNowButton.dataset.listenerAttached = 'true';
            }


            moduleNotificationsToggle.checked = data.settings.notificationsActive;
            modulePackagingToggle.checked = data.settings.modules.packaging;
            moduleBudgetToggle.checked = data.settings.modules.budget;
            moduleScheduledDeliveryToggle.checked = data.settings.modules.scheduledDelivery;
            moduleSocialMediaToggle.checked = data.settings.modules.socialMedia;
            moduleIaWhatsappMgmtToggle.checked = data.settings.modules.iaWhatsappMgmt;
            moduleShippingRatesToggle.checked = data.settings.modules.shippingRates;
            modulePrintCommandToggle.checked = data.settings.modules.printCommand;
            moduleTrackingToggle.checked = data.settings.modules.tracking;
            moduleCommunicationToggle.checked = data.settings.modules.communication;
            moduleCashflowToggle.checked = data.settings.modules.cashflow;

            // Attach event listeners for module toggles only once
            const moduleToggles = document.querySelectorAll('#settings input[type="checkbox"]');
            moduleToggles.forEach(toggle => {
                if (!toggle.dataset.listenerAttached) {
                    toggle.addEventListener('change', async () => {
                        const moduleName = toggle.id.replace('module-', '').replace('ia-whatsapp-mgmt', 'iaWhatsappMgmt').replace('shipping-rates', 'shippingRates').replace('print-command', 'printCommand').replace('scheduled-delivery', 'scheduledDelivery');
                        try {
                            if (moduleName === 'notifications') {
                                await updateDoc(getUserDocRef(), { 'settings.notificationsActive': toggle.checked });
                            } else {
                                await updateDoc(getUserDocRef(), { [`settings.modules.${moduleName}`]: toggle.checked });
                            }
                            updateModuleVisibility(); // Update sidebar visibility
                            await showAlert(`Módulo "${moduleName}" ${toggle.checked ? 'ativado' : 'desativado'}.`, 'Configuração Atualizada');
                        } catch (error) {
                            console.error(`Erro ao atualizar módulo ${moduleName}:`, error);
                            await showAlert(`Erro ao atualizar módulo "${moduleName}": ` + error.message, "Erro");
                        }
                    });
                    toggle.dataset.listenerAttached = 'true';
                }
            });

            document.getElementById('save-settings-btn').onclick = async () => {
                try {
                    await updateDoc(getUserDocRef(), {
                        'settings.deliveryTime': parseInt(document.getElementById('delivery-time').value),
                        'settings.minOrderValue': parseFloat(document.getElementById('min-order-value-setting').value),
                        'settings.scheduleStartDate': document.getElementById('schedule-start-date').value,
                        'settings.scheduleEndDate': document.getElementById('schedule-end-date').value,
                        // Module toggles are handled by individual change listeners
                        // Store status is handled by individual radio change listener
                    });
                    await showAlert('Configurações salvas com sucesso!', 'Sucesso');
                } catch (error) {
                    console.error("Erro ao salvar configurações:", error);
                    await showAlert("Erro ao salvar configurações: " + error.message, "Erro");
                }
            };
        }


        function renderOperatingHours() {
            operatingHoursConfig.innerHTML = '';
            // Ensure days are in correct order (Mon-Sun) for display
            const daysOrder = ['Segunda-feira', 'Terça-feira', 'Quarta-feira', 'Quinta-feira', 'Sexta-feira', 'Sábado', 'Domingo'];
            const sortedHours = [...data.operatingHours].sort((a, b) => daysOrder.indexOf(a.day) - daysOrder.indexOf(b.day));

            sortedHours.forEach(slot => {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'flex items-center space-x-4 bg-slate-50 p-3 rounded-lg border border-slate-200';
                dayDiv.innerHTML = `
                    <p class="w-32 font-semibold text-slate-800">${slot.day}:</p>
                    <input type="time" class="shadow appearance-none border rounded py-1 px-2 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="${slot.open}" data-day="${slot.day}" data-type="open">
                    <span>-</span>
                    <input type="time" class="shadow appearance-none border rounded py-1 px-2 text-slate-700 leading-tight focus:outline-none focus:shadow-outline" value="${slot.close}" data-day="${slot.day}" data-type="close">
                `;
                operatingHoursConfig.appendChild(dayDiv);

                // Add event listeners for time inputs
                dayDiv.querySelectorAll('input[type="time"]').forEach(input => {
                    input.addEventListener('change', async (e) => {
                        const day = e.target.dataset.day;
                        const type = e.target.dataset.type;
                        const value = e.target.value;

                        const updatedOperatingHours = data.operatingHours.map(h => {
                            if (h.day === day) {
                                return { ...h, [type]: value };
                            }
                            return h;
                        });
                        try {
                            await updateDoc(getCollectionRef('operatingHours'), { 'hours': updatedOperatingHours });
                            await showAlert('Horário atualizado com sucesso!', 'Sucesso');
                        } catch (error) {
                            console.error("Erro ao atualizar horário:", error);
                            await showAlert("Erro ao atualizar horário: " + error.message, "Erro");
                        }
                    });
                });
            });
        }

        addHourSlotButton.addEventListener('click', async () => {
            await showAlert('A funcionalidade de adicionar mais turnos por dia será implementada.', 'Aviso');
            // This would typically involve more complex UI for adding multiple time slots for a single day,
            // and saving them to Firestore. For now, it's a conceptual alert.
        });

        function renderPaymentMethods() {
            paymentMethodsConfig.innerHTML = '';
            data.paymentMethods.forEach(method => {
                const methodDiv = document.createElement('div');
                methodDiv.className = 'flex items-center';
                methodDiv.innerHTML = `
                    <label class="inline-flex items-center">
                        <input type="checkbox" class="form-checkbox text-indigo-600" ${method.active ? 'checked' : ''} data-method-name="${method.name}">
                        <span class="ml-2 text-slate-700">${method.name}</span>
                    </label>
                `;
                paymentMethodsConfig.appendChild(methodDiv);

                methodDiv.querySelector('input[type="checkbox"]').addEventListener('change', async (e) => {
                    const methodName = e.target.dataset.methodName;
                    const newActiveStatus = e.target.checked;
                    const updatedPaymentMethods = data.paymentMethods.map(m => {
                        if (m.name === methodName) {
                            return { ...m, active: newActiveStatus };
                        }
                        return m;
                    });
                    try {
                        // Assuming payment methods are stored as an array in a document
                        const settingsDocRef = getUserDocRef();
                        await updateDoc(settingsDocRef, { 'paymentMethods': updatedPaymentMethods });
                        await showAlert('Método de pagamento atualizado!', 'Sucesso');
                    } catch (error) {
                        console.error("Erro ao atualizar método de pagamento:", error);
                        await showAlert("Erro ao atualizar método de pagamento: " + error.message, "Erro");
                    }
                });
            });
        }

        // Financial Section
        function renderFinancial() {
            if (data.settings.modules.cashflow) {
                cashflowModuleContainer.classList.remove('hidden');
                dailyCashModuleContainer.classList.remove('hidden');
                renderCashflow();
                renderDailyCash();
            } else {
                cashflowModuleContainer.classList.add('hidden');
                dailyCashModuleContainer.classList.add('hidden');
            }

            // Update financial summary based on simulated data or actual aggregated data
            document.getElementById('financial-gross-sales').textContent = '5.500,00';
            document.getElementById('financial-commission').textContent = '550,00';
            document.getElementById('financial-monthly-fee').textContent = '79,00';
            document.getElementById('financial-cancellation-credits').textContent = '25,00';
            document.getElementById('financial-taxes').textContent = '8,25';
            document.getElementById('financial-net-total').textContent = '4.887,75';
        }

        let cashflowLineChart;

        function renderCashflow() {
            currentBalanceDisplay.textContent = `R$ ${data.cashflow.balance.toFixed(2)}`;
            transactionsList.innerHTML = '';

            data.cashflow.transactions.forEach(transaction => {
                const transactionDiv = document.createElement('div');
                transactionDiv.className = `bg-slate-50 p-3 rounded-lg border border-slate-200 flex justify-between items-center ${transaction.type === 'expense' ? 'text-red-600' : 'text-green-600'}`;
                const date = transaction.date ? new Date(transaction.date).toLocaleDateString('pt-BR') : 'N/A';
                transactionDiv.innerHTML = `
                    <div>
                        <p class="font-semibold">${transaction.description}</p>
                        <p class="text-xs text-slate-500">${date} - ${transaction.category}</p>
                    </div>
                    <span class="font-bold">${transaction.type === 'expense' ? '-' : '+'} R$ ${transaction.value.toFixed(2)}</span>
                `;
                transactionsList.appendChild(transactionDiv);
            });

            // Render Cashflow Chart
            if (cashflowLineChart) {
                cashflowLineChart.destroy();
            }
            cashflowLineChart = new Chart(cashflowChartCtx, {
                type: 'line',
                data: {
                    labels: data.cashflow.chartData.labels,
                    datasets: [
                        {
                            label: 'Receitas (R$)',
                            data: data.cashflow.chartData.revenues,
                            borderColor: 'rgb(16, 185, 129)', // green-500
                            backgroundColor: 'rgba(16, 185, 129, 0.2)',
                            fill: true,
                            tension: 0.1
                        },
                        {
                            label: 'Despesas (R$)',
                            data: data.cashflow.chartData.expenses,
                            borderColor: 'rgb(239, 68, 68)', // red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            fill: true,
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top' },
                        title: { display: true, text: 'Receitas vs. Despesas Diárias' }
                    },
                    scales: {
                        x: { title: { display: true, text: 'Data' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Valor (R$)' } }
                    }
                }
            });
        }

        cashflowForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const type = document.getElementById('transaction-type').value;
            const value = parseFloat(document.getElementById('transaction-value').value);
            const date = document.getElementById('transaction-date').value;
            const category = document.getElementById('transaction-category').value;
            const description = document.getElementById('transaction-description').value;

            if (!value || !date || !category || !description) {
                await showAlert('Por favor, preencha todos os campos da transação.', 'Campos Faltando');
                return;
            }

            const newTransaction = {
                type,
                value,
                date,
                category,
                description,
                timestamp: serverTimestamp()
            };

            try {
                // Add transaction to a subcollection (to avoid large array in main doc)
                await addDoc(getCollectionRef('cashflowTransactions'), newTransaction);
                await showAlert('Transação registrada!', 'Sucesso');
                cashflowForm.reset();
            } catch (error) {
                console.error("Erro ao registrar transação:", error);
                await showAlert("Erro ao registrar transação: " + error.message, "Erro");
            }
        });

        // Daily Cash Register Functions
        function renderDailyCash() {
            dailyCashStatusDisplay.textContent = data.dailyCash.isOpen ? 'Aberto' : 'Fechado';
            dailyCashStatusDisplay.className = data.dailyCash.isOpen ? 'text-2xl font-bold text-green-600' : 'text-2xl font-bold text-red-600';
            dailyCashOpeningBalanceDisplay.textContent = `R$ ${data.dailyCash.openingBalance.toFixed(2)}`;
            dailyCashCurrentBalanceDisplay.textContent = `R$ ${data.dailyCash.currentBalance.toFixed(2)}`;
            dailyCashTotalInDisplay.textContent = `R$ ${data.dailyCash.totalIn.toFixed(2)}`;
            dailyCashTotalOutDisplay.textContent = `R$ ${data.dailyCash.totalOut.toFixed(2)}`;

            openCashBtn.classList.toggle('hidden', data.dailyCash.isOpen);
            closeCashBtn.classList.toggle('hidden', !data.dailyCash.isOpen);
            addCashMovementBtn.classList.toggle('hidden', !data.dailyCash.isOpen);

            dailyCashMovementsList.innerHTML = '<h4 class="text-lg font-semibold text-slate-800 mb-3">Movimentações do Dia</h4>';
            if (data.dailyCash.movements.length === 0) {
                dailyCashMovementsList.innerHTML += '<p class="text-slate-500">Nenhuma movimentação registrada hoje.</p>';
            } else {
                data.dailyCash.movements.forEach(movement => {
                    const movementDiv = document.createElement('div');
                    movementDiv.className = `bg-slate-50 p-3 rounded-lg border border-slate-200 flex justify-between items-center ${movement.type === 'out' ? 'text-red-600' : 'text-green-600'}`;
                    const time = movement.timestamp.toDate ? movement.timestamp.toDate().toLocaleTimeString('pt-BR') : new Date(movement.timestamp).toLocaleTimeString('pt-BR');
                    movementDiv.innerHTML = `
                        <div>
                            <p class="font-semibold">${movement.description}</p>
                            <p class="text-xs text-slate-500">${time} - ${movement.type === 'in' ? 'Entrada' : 'Saída'}</p>
                        </div>
                        <span class="font-bold">${movement.type === 'out' ? '-' : '+'} R$ ${movement.value.toFixed(2)}</span>
                    `;
                    dailyCashMovementsList.appendChild(movementDiv);
                });
            }
        }

        openCashBtn.addEventListener('click', async () => {
            const initialBalanceInput = await showConfirm('Informe o saldo inicial do caixa:', 'Abrir Caixa');
            if (initialBalanceInput) {
                const initialBalance = parseFloat(prompt('Saldo inicial (ex: 100.00):'));
                if (!isNaN(initialBalance) && initialBalance >= 0) {
                    try {
                        await updateDoc(getDocRef('dailyCash'), {
                            isOpen: true,
                            openingBalance: initialBalance,
                            currentBalance: initialBalance,
                            totalIn: 0,
                            totalOut: 0,
                            movements: [],
                            lastOpened: serverTimestamp()
                        });
                        await showAlert('Caixa aberto com sucesso!', 'Sucesso');
                    } catch (error) {
                        console.error("Erro ao abrir caixa:", error);
                        await showAlert("Erro ao abrir caixa: " + error.message, "Erro");
                    }
                } else {
                    await showAlert('Valor inválido. Por favor, insira um número válido.', 'Erro');
                }
            }
        });

        closeCashBtn.addEventListener('click', async () => {
            const confirmed = await showConfirm(`Deseja realmente fechar o caixa com saldo final de R$ ${data.dailyCash.currentBalance.toFixed(2)}?`, 'Fechar Caixa');
            if (confirmed) {
                try {
                    await updateDoc(getDocRef('dailyCash'), {
                        isOpen: false,
                        lastClosed: serverTimestamp(),
                        // Optionally reset balances or archive for reporting
                    });
                    await showAlert('Caixa fechado com sucesso! Saldo final: R$ ' + data.dailyCash.currentBalance.toFixed(2), 'Sucesso');
                } catch (error) {
                    console.error("Erro ao fechar caixa:", error);
                    await showAlert("Erro ao fechar caixa: " + error.message, "Erro");
                }
            }
        });

        addCashMovementBtn.addEventListener('click', async () => {
            const movementType = prompt('Tipo de movimento (entrada/saída):').toLowerCase();
            if (movementType !== 'entrada' && movementType !== 'saída') {
                await showAlert('Tipo de movimento inválido. Use "entrada" ou "saída".', 'Erro');
                return;
            }
            const value = parseFloat(prompt('Valor do movimento:'));
            if (isNaN(value) || value <= 0) {
                await showAlert('Valor inválido.', 'Erro');
                return;
            }
            const description = prompt('Descrição do movimento:');
            if (!description) {
                await showAlert('Descrição é obrigatória.', 'Erro');
                return;
            }

            const newMovement = {
                type: movementType === 'entrada' ? 'in' : 'out',
                value: value,
                description: description,
                timestamp: serverTimestamp()
            };

            try {
                // Update movements array in Firestore and also current balance
                const updatedMovements = [...data.dailyCash.movements, newMovement];
                let newCurrentBalance = data.dailyCash.currentBalance;
                let newTotalIn = data.dailyCash.totalIn;
                let newTotalOut = data.dailyCash.totalOut;

                if (newMovement.type === 'in') {
                    newCurrentBalance += value;
                    newTotalIn += value;
                } else {
                    newCurrentBalance -= value;
                    newTotalOut += value;
                }

                await updateDoc(getDocRef('dailyCash'), {
                    movements: updatedMovements,
                    currentBalance: newCurrentBalance,
                    totalIn: newTotalIn,
                    totalOut: newTotalOut
                });
                await showAlert('Movimento registrado!', 'Sucesso');
            } catch (error) {
                console.error("Erro ao registrar movimento de caixa:", error);
                await showAlert("Erro ao registrar movimento de caixa: " + error.message, "Erro");
            }
        });


        // Reviews Section
        function renderReviews() {
            reviewsList.innerHTML = '';
            data.reviews.forEach(review => {
                const reviewDiv = document.createElement('div');
                reviewDiv.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200';
                const reviewDate = review.date ? new Date(review.date).toLocaleDateString('pt-BR') : 'N/A';
                reviewDiv.innerHTML = `
                    <div class="flex items-center mb-2">
                        <span class="text-amber-500 text-xl mr-2">${'⭐'.repeat(review.rating)}</span>
                        <p class="font-semibold text-slate-800">${review.customer}</p>
                        <p class="text-slate-500 text-sm ml-auto">${reviewDate}</p>
                    </div>
                    <p class="text-slate-600">"${review.comment}"</p>
                `;
                reviewsList.appendChild(reviewDiv);
            });
            // Update dashboard review stats as well
            updateDashboardMetrics();
        }

        // Sales Growth Tips Section
        generatePromoIdeasBtn.addEventListener('click', async () => {
            const originalButtonText = generatePromoIdeasBtn.textContent;
            generatePromoIdeasBtn.textContent = 'Gerando ideias...';
            generatePromoIdeasBtn.disabled = true;
            promotionIdeasOutput.innerHTML = '';

            try {
                const prompt = `Gerar 3 ideias de promoções inovadoras e eficazes para um restaurante de delivery que vende pizzas, hambúrgueres e sushi. Focar em atrair novos clientes e aumentar o ticket médio. Limite cada ideia a uma frase e separe por ponto e vírgula.`;
                const payload = { contents: [{ role: "user", parts: [{ text: prompt }] }] };
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) {
                    const ideas = result.candidates[0].content.parts[0].text.split(';').map(s => s.trim()).filter(s => s.length > 0);
                    ideas.forEach(idea => {
                        const ideaDiv = document.createElement('div');
                        ideaDiv.className = 'bg-blue-50 p-3 rounded-lg text-blue-800 border border-blue-200';
                        ideaDiv.textContent = `💡 ${idea}`;
                        promotionIdeasOutput.appendChild(ideaDiv);
                    });
                } else {
                    promotionIdeasOutput.innerHTML = '<p class="text-slate-500">Não foi possível gerar ideias de promoção. Tente novamente.</p>';
                }
            } catch (error) {
                console.error('Erro ao gerar ideias de promoção:', error);
                promotionIdeasOutput.innerHTML = '<p class="text-red-500">Erro ao gerar ideias de promoção: ' + error.message + '</p>';
            } finally {
                generatePromoIdeasBtn.textContent = originalButtonText;
                generatePromoIdeasBtn.disabled = false;
            }
        });

        function renderSalesGrowthTips() {
            salesGrowthAccordion.innerHTML = '';
            data.salesGrowthTips.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-slate-50 rounded-lg border border-slate-200 overflow-hidden';
                
                const button = document.createElement('button');
                button.className = 'accordion-header';
                button.innerHTML = `<span>${item.title}</span> <span class="accordion-button-icon">▼</span>`;

                const content = document.createElement('div');
                content.className = 'accordion-content';
                content.innerHTML = `<p>${item.content}</p>`;

                button.addEventListener('click', () => {
                    const isActive = button.classList.toggle('active');
                    if (isActive) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    } else {
                        content.style.maxHeight = '0';
                    }
                });

                wrapper.appendChild(button);
                wrapper.appendChild(content);
                salesGrowthAccordion.appendChild(wrapper);
            });
        }

        // Packaging Section
        function renderPackaging() {
            packagingList.innerHTML = '';
            data.packaging.forEach(item => {
                const packagingDiv = document.createElement('div');
                packagingDiv.className = 'bg-slate-50 p-4 rounded-lg flex justify-between items-center border border-slate-200';
                packagingDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${item.name}</p>
                        <p class="text-slate-700">Custo: R$ ${item.cost.toFixed(2)}</p>
                    </div>
                    <div class="flex flex-col items-end space-y-2">
                        <span class="order-status-badge ${item.active ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${item.active ? 'Ativa' : 'Inativa'}</span>
                        <div class="flex space-x-2">
                            <button class="text-indigo-600 hover:text-indigo-800 font-semibold text-sm" onclick="editPackaging('${item.id}')">Editar</button>
                            <button class="text-red-600 hover:text-red-800 font-semibold text-sm" onclick="deletePackaging('${item.id}')">Excluir</button>
                        </div>
                    </div>
                `;
                packagingList.appendChild(packagingDiv);
            });
        }

        packagingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const newPackaging = {
                name: document.getElementById('packaging-name').value,
                cost: parseFloat(document.getElementById('packaging-cost').value),
                active: document.getElementById('packaging-active').checked,
                createdAt: serverTimestamp()
            };
            try {
                await addDoc(getCollectionRef('packaging'), newPackaging);
                await showAlert('Embalagem adicionada com sucesso!', 'Sucesso');
                packagingForm.reset();
            } catch (error) {
                console.error("Erro ao adicionar embalagem:", error);
                await showAlert("Erro ao adicionar embalagem: " + error.message, "Erro");
            }
        });

        async function editPackaging(id) {
            await showAlert(`Funcionalidade de edição para a embalagem ${id} será implementada.`, 'Aviso');
        }

        async function deletePackaging(id) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir a embalagem ${id}?`);
            if (confirmed) {
                try {
                    await deleteDoc(getDocRef('packaging', id));
                    await showAlert('Embalagem excluída com sucesso!', 'Sucesso');
                } catch (error) {
                    console.error("Erro ao excluir embalagem:", error);
                    await showAlert("Erro ao excluir embalagem: " + error.message, "Erro");
                }
            }
        }

        // Budget Requests Section
        function renderBudgetRequests() {
            budgetRequestsList.innerHTML = '';
            data.budgetRequests.forEach(request => {
                const requestDiv = document.createElement('div');
                requestDiv.className = 'bg-slate-50 p-4 rounded-lg border border-slate-200';
                const requestDate = request.date ? new Date(request.date).toLocaleDateString('pt-BR') : 'N/A';
                requestDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-2">
                        <p class="font-bold text-slate-900">Orçamento #${request.id}</p>
                        <span class="order-status-badge ${request.status === 'Pendente' ? 'bg-amber-100 text-amber-600' : request.status === 'Aprovado' ? 'bg-green-100 text-green-600' : 'bg-red-100 text-red-600'}">${request.status}</span>
                    </div>
                    <p class="text-slate-700">Cliente: ${request.customer}</p>
                    <p class="text-slate-700">Data: ${requestDate}</p>
                    <p class="text-slate-600 text-sm">Descrição: ${request.description}</p>
                    ${request.value ? `<p class="text-slate-700 mt-2">Valor Sugerido: R$ ${request.value.toFixed(2)}</p>` : ''}
                    <div class="mt-3 flex flex-wrap gap-2">
                        <button class="bg-indigo-500 hover:bg-indigo-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateBudgetStatus('${request.id}', 'Aprovado')">Aprovar</button>
                        <button class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded-full transition" onclick="updateBudgetStatus('${request.id}', 'Rejeitado')">Rejeitar</button>
                    </div>
                `;
                budgetRequestsList.appendChild(requestDiv);
            });
        }

        async function updateBudgetStatus(id, newStatus) {
            const requestRef = getDocRef('budgetRequests', id);
            if (requestRef) {
                try {
                    let value = data.budgetRequests.find(req => req.id === id)?.value;
                    if (newStatus === 'Aprovado' && value === null) {
                        const input = prompt('Por favor, insira o valor do orçamento aprovado:');
                        if (input) value = parseFloat(input);
                    }
                    await updateDoc(requestRef, { status: newStatus, value: value });
                    await showAlert(`Orçamento #${id} atualizado para: ${newStatus}`, 'Sucesso');
                } catch (error) {
                    console.error("Erro ao atualizar status do orçamento:", error);
                    await showAlert("Erro ao atualizar status do orçamento: " + error.message, "Erro");
                }
            }
        }

        // Social Media Section
        function renderSocialMediaSettings() {
            document.getElementById('social-facebook').value = data.socialMedia.facebook || '';
            document.getElementById('social-instagram').value = data.socialMedia.instagram || '';
            document.getElementById('social-twitter').value = data.socialMedia.twitter || '';
            document.getElementById('social-whatsapp').value = data.socialMedia.whatsapp || '';

            // Attach event listener only once
            if (!document.getElementById('social-media-form').dataset.listenerAttached) {
                document.getElementById('social-media-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const updatedSocialMedia = {
                        facebook: document.getElementById('social-facebook').value,
                        instagram: document.getElementById('social-instagram').value,
                        twitter: document.getElementById('social-twitter').value,
                        whatsapp: document.getElementById('social-whatsapp').value
                    };
                    try {
                        await setDoc(doc(getUserDocRef(), 'socialMedia'), updatedSocialMedia);
                        await showAlert('Links de Redes Sociais salvos!', 'Sucesso');
                    } catch (error) {
                        console.error("Erro ao salvar redes sociais:", error);
                        await showAlert("Erro ao salvar links de redes sociais: " + error.message, "Erro");
                    }
                });
                document.getElementById('social-media-form').dataset.listenerAttached = 'true';
            }
        }

        // Shipping Section
        function renderShippingSettings() {
            // Set initial radio state
            document.querySelector(`input[name="shipping-model"][value="${data.shippingRates.model || 'radius'}"]`).checked = true;
            updateShippingModelVisibility(data.shippingRates.model || 'radius');

            // Populate current values
            document.getElementById('radius-km').value = data.shippingRates.radius?.km || 5;
            document.getElementById('cost-per-km').value = data.shippingRates.radius?.costPerKm || 2.00;
            document.getElementById('fixed-shipping-cost').value = data.shippingRates.fixed?.cost || 8.00;
            document.getElementById('free-shipping-min-value').value = data.shippingRates.freeMinOrder?.value || 100.00;

            shippingModelRadios.forEach(radio => {
                if (!radio.dataset.listenerAttached) {
                    radio.addEventListener('change', (e) => {
                        updateShippingModelVisibility(e.target.value);
                    });
                    radio.dataset.listenerAttached = 'true';
                }
            });

            // Save functionality
            const saveShippingBtn = document.querySelector('#shipping button[type="submit"]');
            if (!saveShippingBtn.dataset.listenerAttached) {
                saveShippingBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    const selectedModel = document.querySelector('input[name="shipping-model"]:checked').value;
                    const updatedShippingRates = { model: selectedModel };

                    if (selectedModel === 'radius') {
                        updatedShippingRates.radius = {
                            km: parseFloat(document.getElementById('radius-km').value),
                            costPerKm: parseFloat(document.getElementById('cost-per-km').value)
                        };
                    } else if (selectedModel === 'fixed') {
                        updatedShippingRates.fixed = {
                            cost: parseFloat(document.getElementById('fixed-shipping-cost').value)
                        };
                    } else if (selectedModel === 'free-min-order') {
                        updatedShippingRates.freeMinOrder = {
                            value: parseFloat(document.getElementById('free-shipping-min-value').value)
                        };
                    }
                    try {
                        await setDoc(doc(getUserDocRef(), 'shippingRates'), updatedShippingRates);
                        await showAlert('Configurações de Frete salvas!', 'Sucesso');
                    } catch (error) {
                        console.error("Erro ao salvar configurações de frete:", error);
                        await showAlert("Erro ao salvar configurações de frete: " + error.message, "Erro");
                    }
                });
                saveShippingBtn.dataset.listenerAttached = 'true';
            }
        }

        function updateShippingModelVisibility(model) {
            shippingRadiusConfig.classList.toggle('hidden', model !== 'radius');
            shippingFixedConfig.classList.toggle('hidden', model !== 'fixed');
            shippingFreeMinOrderConfig.classList.toggle('hidden', model !== 'free-min-order');
        }

        // IA WhatsApp Management Section
        function renderIaWhatsappManagement() {
            document.getElementById('ia-welcome-message-active').checked = data.iaWhatsappConfig.welcomeMessageActive || false;
            document.getElementById('ia-welcome-message-text').value = data.iaWhatsappConfig.welcomeMessageText || '';
            document.getElementById('ia-faq-active').checked = data.iaWhatsappConfig.faqActive || false;
            document.getElementById('ia-proactive-alerts-active').checked = data.iaWhatsappConfig.proactiveAlertsActive || false;

            // Attach event listener only once
            if (!iaWhatsappConfigForm.dataset.listenerAttached) {
                iaWhatsappConfigForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const updatedIaConfig = {
                        welcomeMessageActive: document.getElementById('ia-welcome-message-active').checked,
                        welcomeMessageText: document.getElementById('ia-welcome-message-text').value,
                        faqActive: document.getElementById('ia-faq-active').checked,
                        proactiveAlertsActive: document.getElementById('ia-proactive-alerts-active').checked
                    };
                    try {
                        await setDoc(doc(getUserDocRef(), 'iaWhatsappConfig'), updatedIaConfig);
                        await showAlert('Configurações do Agente IA salvas!', 'Sucesso');
                    } catch (error) {
                        console.error("Erro ao salvar configurações IA WhatsApp:", error);
                        await showAlert("Erro ao salvar configurações IA WhatsApp: " + error.message, "Erro");
                    }
                });
                iaWhatsappConfigForm.dataset.listenerAttached = 'true';
            }
        }

        // Communication Section (Message Templates)
        function renderCommunicationSettings() {
            messageTemplatesList.innerHTML = '';
            data.messageTemplates.forEach(template => {
                const templateDiv = document.createElement('div');
                templateDiv.className = 'bg-slate-50 p-3 rounded-lg border border-slate-200 flex justify-between items-center';
                templateDiv.innerHTML = `
                    <div>
                        <p class="font-semibold text-slate-800">${template.name}</p>
                        <p class="text-slate-600 text-sm">${template.text}</p>
                    </div>
                    <button class="text-red-600 hover:text-red-800 text-sm" onclick="deleteMessageTemplate('${template.id}')">Excluir</button>
                `;
                messageTemplatesList.appendChild(templateDiv);
            });

            // Attach event listener only once
            if (!messageTemplateForm.dataset.listenerAttached) {
                messageTemplateForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const newTemplate = {
                        name: document.getElementById('template-name').value,
                        text: document.getElementById('template-text').value,
                        createdAt: serverTimestamp()
                    };
                    try {
                        await addDoc(getCollectionRef('messageTemplates'), newTemplate);
                        await showAlert('Template de mensagem salvo!', 'Sucesso');
                        messageTemplateForm.reset();
                    } catch (error) {
                        console.error("Erro ao salvar template de mensagem:", error);
                        await showAlert("Erro ao salvar template de mensagem: " + error.message, "Erro");
                    }
                });
                messageTemplateForm.dataset.listenerAttached = 'true';
            }
        }

        async function deleteMessageTemplate(id) {
            const confirmed = await showConfirm(`Tem certeza que deseja excluir este template de mensagem?`);
            if (confirmed) {
                try {
                    await deleteDoc(getDocRef('messageTemplates', id));
                    await showAlert('Template de mensagem excluído!', 'Sucesso');
                } catch (error) {
                    console.error("Erro ao excluir template:", error);
                    await showAlert("Erro ao excluir template: " + error.message, "Erro");
                }
            }
        }


        // FAQ Section
        function renderFaq() {
            faqAccordion.innerHTML = '';
            data.faq.forEach((item, index) => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bg-slate-50 rounded-lg border border-slate-200 overflow-hidden';
                
                const button = document.createElement('button');
                button.className = 'accordion-header';
                button.innerHTML = `<span>${item.question}</span> <span class="accordion-button-icon">▼</span>`;

                const content = document.createElement('div');
                content.className = 'accordion-content';
                content.innerHTML = `<p>${item.answer}</p>`;

                button.addEventListener('click', () => {
                    const isActive = button.classList.toggle('active');
                    if (isActive) {
                        content.style.maxHeight = content.scrollHeight + 'px';
                    } else {
                        content.style.maxHeight = '0';
                    }
                });

                wrapper.appendChild(button);
                wrapper.appendChild(content);
                faqAccordion.appendChild(wrapper);
            });
        }

        // Initial render on page load
        document.addEventListener('DOMContentLoaded', () => {
            // No initial data load here; it's handled by onAuthStateChanged
            // showSection('dashboard'); will be called after auth and initial data sync
        });

        // Simulate a new order arriving periodically
        setInterval(async () => {
            if (isAuthReady && userId) { // Only simulate if authenticated
                const simulatedOrder = {
                    id: 'DRZ' + Math.floor(Math.random() * 1000).toString().padStart(3, '0'),
                    customer: `Cliente Teste ${Math.floor(Math.random() * 100)}`,
                    total: parseFloat((Math.random() * 100 + 20).toFixed(2)),
                    status: 'Confirmado',
                    items: [{ name: 'Item Teste', qty: 1 }],
                    timestamp: serverTimestamp(),
                    confirmationTime: null,
                    scheduledTime: null,
                    kdsStatus: 'Pendente',
                    chatHistory: [{ sender: 'client', text: 'Olá! Qual o prazo de entrega?' }]
                };
                try {
                    // Check if this order ID already exists to avoid duplicates in simulation
                    const existingOrder = data.orders.find(o => o.id === simulatedOrder.id);
                    if (!existingOrder) {
                        await addDoc(getCollectionRef('orders'), simulatedOrder);
                    }
                } catch (error) {
                    console.error("Erro ao simular novo pedido:", error);
                }
            }
        }, 30000); // Simulate a new order every 30 seconds

    </script>
</body>
</html>
